
<!-- Image Cropper Modal -->
<app-image-cropper-modal
  #imageCropper
  [imageFile]="selectedImageFile"
  [roundCropper]="true"
  [aspectRatio]="1"
  [resizeToWidth]="300"
  [resizeToHeight]="300"
  (imageCropped)="onImageCropped($event)"
  (cancelled)="onCropCancelled()">
</app-image-cropper-modal>

<div *ngIf="isParent()" [class]="isParent() ? '' : ' mt-4'">
    <div *ngIf="child && !loading" class="parent-detailchild font-inter">
      <app-parent-child-header
        [title]="'EDIT_CHILD.TITLE' | translate"
        [children]="[child]"
        [currentChildIndex]="0"
        [showDatePicker]="false"
        [showSettings]="false"
        [showEdit]="false"
        [showImages]="true"
        [hasCustomContent]="false"
        (onBack)="back()">
      </app-parent-child-header>
      <div class="body container-fluid">
        <div class="card card-general">
          <div class="card-header">
            <h5>{{ 'EDIT_CHILD.GENERAL_INFO' | translate }}</h5>
          </div>
          <div class="card-body">
            <form (ngSubmit)="updateChild()">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">{{ 'EDIT_CHILD.FIRST_NAME' | translate }} {{ 'EDIT_CHILD.REQUIRED' | translate }}</label>
                  <input type="text" class="form-control" [(ngModel)]="child.firstName" name="firstName" required>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">{{ 'EDIT_CHILD.LAST_NAME' | translate }} {{ 'EDIT_CHILD.REQUIRED' | translate }}</label>
                  <input type="text" class="form-control" [(ngModel)]="child.lastName" name="lastName" required>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">{{ 'EDIT_CHILD.DATE_OF_BIRTH' | translate }} {{ 'EDIT_CHILD.REQUIRED' | translate }}</label>
                  <input type="date" class="form-control" [(ngModel)]="child.dateOfBirth" name="dateOfBirth" required>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">{{ 'EDIT_CHILD.GENDER' | translate }} {{ 'EDIT_CHILD.REQUIRED' | translate }}</label>
                  <select class="form-select" [(ngModel)]="child.gender" name="gender" required>
                    <option value="">{{ 'EDIT_CHILD.SELECT_GENDER' | translate }}</option>
                    <option *ngFor="let gender of genders" [value]="gender.value">
                      {{ gender.label }}
                    </option>
                  </select>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">{{ 'EDIT_CHILD.PROFILE_PICTURE' | translate }}</label>
                  <input type="file" class="form-control" (change)="onImageSelect($event)" accept="image/*">
                  <img *ngIf="imagePreview" loading="lazy" [src]="imagePreview" class="mt-2 rounded" width="100" height="100" [alt]="'GLOBAL.PREVIEW' | translate">
                </div>
                <div class="col-md-6 mb-3">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" [(ngModel)]="child.isActive" name="isActive" id="isActiveEdit">
                    <label class="form-check-label" for="isActiveEdit">
                      {{ 'EDIT_CHILD.ACTIVE_STATUS' | translate }}
                    </label>
                  </div>
                </div>
                <div class="col-12 mb-3">
                  <label class="form-label">{{ 'EDIT_CHILD.ALLERGIES' | translate }}</label>
                  <textarea class="form-control" [(ngModel)]="child.allergies" name="allergies" rows="3" [placeholder]="'EDIT_CHILD.ALLERGIES_PLACEHOLDER' | translate"></textarea>
                </div>
                <div class="col-12 mb-3">
                  <label class="form-label">{{ 'EDIT_CHILD.MEDICAL_NOTES' | translate }}</label>
                  <textarea class="form-control" [(ngModel)]="child.medicalNotes" name="medicalNotes" rows="3" [placeholder]="'EDIT_CHILD.MEDICAL_NOTES_PLACEHOLDER' | translate"></textarea>
                </div>
              </div>
              <div class="d-flex gap-2 flex-row-reverse">
                <button type="submit" class="custom-btn-2 btn-add-global-2" [disabled]="saving">
                  <span *ngIf="saving" class="spinner-border spinner-border-sm me-2"></span>
                  {{ saving ? ('EDIT_CHILD.UPDATING' | translate) : ('EDIT_CHILD.UPDATE_CHILD' | translate) }}
                </button>
                <button type="button" class="btn btn-cancel-global" (click)="cancel()" [disabled]="saving">{{ 'EDIT_CHILD.CANCEL' | translate }}</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
</div>
<div  *ngIf="!isParent()" class="edit-child-container">
  <div class="container-fluid mt-4 mb-4">
    <app-title-page [title]="'EDIT_CHILD.TITLE' | translate" [breadcrumbs]="breadcrumbs" [actions]="titleActions">
    </app-title-page>

    <!-- Loading -->
    <div *ngIf="loading" class="text-center py-5">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">{{ 'EDIT_CHILD.LOADING' | translate }}</span>
      </div>
    </div>

    <div class="card-add-pages" *ngIf="!loading">
      <form [formGroup]="childForm" (ngSubmit)="updateChild()" class="add-form">
        <!-- Section Personal Information -->
        <div class="form-section">
          <div class="section-header">
            <i class="bi bi-person-circle"></i>
            <h4>{{ 'EDIT_CHILD.GENERAL_INFO' | translate }}</h4>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">{{ 'EDIT_CHILD.FIRST_NAME' | translate }} {{ 'EDIT_CHILD.REQUIRED' | translate }}</label>
              <div class="input-with-icon">
                <i class="bi bi-person input-icon"></i>
                <input type="text" class="form-input" [class.is-invalid]="isFieldInvalid('firstName')" formControlName="firstName" [placeholder]="'GLOBAL.FIRST_NAME_PLACEHOLDER' | translate">
              </div>
              <div *ngIf="isFieldInvalid('firstName')" class="error-message">
                {{ getFieldError('firstName') }}
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">{{ 'EDIT_CHILD.LAST_NAME' | translate }} {{ 'EDIT_CHILD.REQUIRED' | translate }}</label>
              <div class="input-with-icon">
                <i class="bi bi-person input-icon"></i>
                <input type="text" class="form-input" [class.is-invalid]="isFieldInvalid('lastName')" formControlName="lastName" [placeholder]="'GLOBAL.LAST_NAME_PLACEHOLDER' | translate">
              </div>
              <div *ngIf="isFieldInvalid('lastName')" class="error-message">
                {{ getFieldError('lastName') }}
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">{{ 'EDIT_CHILD.GENDER' | translate }} {{ 'EDIT_CHILD.REQUIRED' | translate }}</label>
              <div class="input-with-icon">
                <i class="bi bi-gender-ambiguous input-icon"></i>
                <ng-select
                  class="form-input"
                  [class.is-invalid]="isFieldInvalid('gender')"
                  formControlName="gender"
                  [items]="genders"
                  bindLabel="label"
                  bindValue="value"
                  [placeholder]="'EDIT_CHILD.SELECT_GENDER' | translate"
                  [clearable]="false"
                  [searchable]="false">
                  <!-- Custom option template with icon -->
                  <ng-template ng-option-tmp let-item="item">
                    <div class="option-with-image">
                      <i class="bi {{item.icon}}" style="font-size: 18px; color: #7dd3c0;"></i>
                      <span class="option-title">{{ item.label }}</span>
                    </div>
                  </ng-template>
                </ng-select>
              </div>
              <div *ngIf="isFieldInvalid('gender')" class="error-message">
                {{ getFieldError('gender') }}
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">{{ 'EDIT_CHILD.DATE_OF_BIRTH' | translate }} {{ 'EDIT_CHILD.REQUIRED' | translate }}</label>
              <div class="input-with-icon">
                <i class="bi bi-calendar input-icon"></i>
                <input type="date" class="form-input" [class.is-invalid]="isFieldInvalid('dateOfBirth')" formControlName="dateOfBirth">
              </div>
              <div *ngIf="isFieldInvalid('dateOfBirth')" class="error-message">
                {{ getFieldError('dateOfBirth') }}
              </div>
            </div>
          </div>
        </div>

        <!-- Section Parent Selection (only for admin/teacher) -->
        <div class="form-section" *ngIf="!isParent()">
          <div class="section-header">
            <i class="bi bi-people"></i>
            <h4>{{ 'EDIT_CHILD.PARENT' | translate }}</h4>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">{{ 'EDIT_CHILD.PARENT' | translate }} {{ 'EDIT_CHILD.REQUIRED' | translate }}</label>
              <div class="input-with-icon">
                <i class="bi bi-person-badge input-icon"></i>
                <ng-select
                  class="form-input"
                  [class.is-invalid]="isFieldInvalid('parentId')"
                  formControlName="parentId"
                  [items]="parents"
                  bindLabel="firstName"
                  bindValue="id"
                  [placeholder]="'EDIT_CHILD.SELECT_PARENT' | translate"
                  [clearable]="true"
                  [searchable]="true">
                  <!-- Custom option template with image -->
                  <ng-template ng-option-tmp let-item="item">
                    <div class="option-with-image">
                      <img [src]="item?.profilePicture || 'assets/father.png'" class="option-image" alt="">
                      <div class="option-text">
                        <span class="option-title">{{ item.firstName }} {{ item.lastName }}</span>
                        <span class="option-subtitle">{{ item.email }}</span>
                      </div>
                    </div>
                  </ng-template>
                  <!-- Custom selected label template -->
                  <ng-template ng-label-tmp let-item="item">
                    <div class="selected-with-image" *ngIf="item?.id">
                      <img [src]="item?.profilePicture || 'assets/father.png'" class="selected-image" alt="">
                      <span class="selected-text">{{ item.firstName }} {{ item.lastName }}</span>
                    </div>
                  </ng-template>
                </ng-select>
              </div>
              <div *ngIf="isFieldInvalid('parentId')" class="error-message">
                {{ getFieldError('parentId') }}
              </div>
            </div>
          </div>
        </div>

        <!-- Section Medical Information -->
        <div class="form-section">
          <div class="section-header">
            <i class="bi bi-heart-pulse"></i>
            <h4>{{ 'EDIT_CHILD.MEDICAL_INFO' | translate }}</h4>
          </div>
          <div class="form-grid">
            <div class="form-group full-width textarea">
              <label class="form-label">{{ 'EDIT_CHILD.ALLERGIES' | translate }}</label>
              <div class="input-with-icon">
                <i class="bi bi-exclamation-triangle input-icon"></i>
                <textarea class="form-input" [class.is-invalid]="isFieldInvalid('allergies')" formControlName="allergies" rows="3" [placeholder]="'EDIT_CHILD.ALLERGIES_PLACEHOLDER' | translate"></textarea>
              </div>
              <div *ngIf="isFieldInvalid('allergies')" class="error-message">
                {{ getFieldError('allergies') }}
              </div>
            </div>
            <div class="form-group full-width">
              <label class="form-label">{{ 'EDIT_CHILD.MEDICAL_NOTES' | translate }}</label>
              <div class="input-with-icon">
                <i class="bi bi-clipboard2-pulse input-icon"></i>
                <textarea class="form-input" [class.is-invalid]="isFieldInvalid('medicalNotes')" formControlName="medicalNotes" rows="3" [placeholder]="'EDIT_CHILD.MEDICAL_NOTES_PLACEHOLDER' | translate"></textarea>
              </div>
              <div *ngIf="isFieldInvalid('medicalNotes')" class="error-message">
                {{ getFieldError('medicalNotes') }}
              </div>
            </div>
          </div>
        </div>

        <!-- Section Photo and Status -->
        <div class="form-section">
          <div class="section-header">
            <i class="bi bi-image"></i>
            <h4>{{ 'EDIT_CHILD.PHOTO_STATUS' | translate }}</h4>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">{{ 'EDIT_CHILD.PROFILE_PICTURE' | translate }}</label>
              <div class="file-upload-area">
                <input type="file" #fileInput id="profilePicture" class="file-input" (change)="onImageSelect($event)" accept="image/jpeg,image/png,image/gif,image/webp">
                <label for="profilePicture" class="file-upload-label">
                  <div *ngIf="!imagePreview" class="upload-placeholder">
                    <i class="bi bi-cloud-upload"></i>
                    <span>{{ 'GLOBAL.UPLOAD_PHOTO' | translate }}</span>
                  </div>
                  <img *ngIf="imagePreview" [src]="imagePreview" class="preview-image" [alt]="'GLOBAL.PREVIEW' | translate">
                </label>
                <button *ngIf="imagePreview" type="button" class="btn-remove-image" (click)="removeImage()">
                  <i class="bi bi-x-circle"></i>
                  {{ 'GLOBAL.REMOVE_PHOTO' | translate }}
                </button>
              </div>
              <small class="form-hint">{{ 'GLOBAL.IMAGE_HINT' | translate }}</small>
            </div>
            <div class="form-group">
              <label class="form-label">{{ 'EDIT_CHILD.STATUS' | translate }}</label>
              <div class="status-toggle">
                <label class="toggle-label">{{ 'EDIT_CHILD.ACTIVE_STATUS' | translate }}</label>
                <div class="toggle-switch">
                  <input type="checkbox" formControlName="isActive" id="isActive" class="toggle-input">
                  <label for="isActive" class="toggle-slider"></label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="form-actions">
          <button type="button" class="custom-btn-2 btn-cancel-2" (click)="cancel()" [disabled]="saving">
            <i class="bi bi-x-circle"></i>
            {{ 'EDIT_CHILD.CANCEL' | translate }}
          </button>
          <button type="submit" class="custom-btn-2 btn-add-global-2" [disabled]="saving || childForm.invalid">
            <span *ngIf="saving" class="spinner-border spinner-border-sm me-2"></span>
            <i *ngIf="!saving" class="bi bi-check-circle"></i>
            {{ saving ? ('EDIT_CHILD.UPDATING' | translate) : ('EDIT_CHILD.UPDATE_CHILD' | translate) }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
