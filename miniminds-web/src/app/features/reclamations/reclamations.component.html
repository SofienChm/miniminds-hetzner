<div *ngIf="isParent" class="parent-detailchild font-inter">
  <app-parent-child-header-simple *ngIf="isParent"
        title="Reclamation"
      >
  </app-parent-child-header-simple>

  <div class="body container-fluid">
    <div class="main-information">
      <div class="row">
    <div [class]="isParent ? 'col-12 mb-3' : 'col-md-4'">
      <div class="panel reclamations-panel">
        <div class="panel-header">
          <div class="left-reclamation-title">
            <h4>Reclamations</h4>
          </div>
        </div>
        <div class="panel-body">
          <div class="tabs">
            <div class="tab" [class.active]="activeTab === 'received'" (click)="switchTab('received')">
              Received ({{ receivedReclamations.length }})
            </div>
            <div class="tab" [class.active]="activeTab === 'sent'" (click)="switchTab('sent')">
              Sent ({{ sentReclamations.length }})
            </div>
          </div>
          
          <div class="reclamations-list">
            <div class="reclamation-item" [class.resolved]="reclamation.isResolved"
              *ngFor="let reclamation of activeReclamations" (click)="selectReclamation(reclamation)">
              <div class="reclamation-subject">{{ reclamation.subject }}</div>
              <div class="reclamation-content">{{ reclamation.content.substring(0, 100) }}{{ reclamation.content.length > 100 ? '...' : '' }}</div>
              <div class="reclamation-meta">
                <span class="reclamation-date">{{ formatDate(reclamation.sentAt) }}</span>
                <span class="reclamation-status" [class.open]="!reclamation.isResolved" [class.resolved]="reclamation.isResolved">
                  {{ reclamation.isResolved ? 'Resolved' : 'Open' }}
                </span>
              </div>
            </div>
            <div class="empty muted" *ngIf="activeReclamations.length === 0">
              No reclamations found
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div *ngIf="!isParent" class="col-md-8">
      <div class="panel">
        <div class="panel-header">
          <div>New Reclamation</div>
        </div>
        <div class="panel-body reclamation-body">
          <div>
            <div class="input-row" *ngIf="!authService.isParent()">
              <select class="input" [(ngModel)]="newReclamation.recipientId" required>
                <option value="">Select recipient</option>
                <option *ngFor="let user of users" [value]="user.id">
                  {{ user.name }} ({{ user.email }})
                </option>
              </select>
            </div>
            <div class="input-row" style="margin-top: 12px;">
              <input type="text" class="input" placeholder="Subject" [(ngModel)]="newReclamation.subject" required>
            </div>
            <div class="input-row" style="margin-top: 12px;">
              <textarea class="textarea" placeholder="Content" [(ngModel)]="newReclamation.content" required></textarea>
            </div>
            <div class="input-row" style="margin-top: 12px;">
              <button class="send" (click)="send()" [disabled]="(!authService.isParent() && !newReclamation.recipientId) || !newReclamation.subject.trim() || !newReclamation.content.trim()">
                <i class="bi bi-send"></i> Send Reclamation
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="float-btn" (click)="openNewReclamationModal()">
    <i class="bi bi-plus"></i>
    Add reclamation
  </div>
    </div>
  </div>
</div>

<div *ngIf="!isParent"  [class]="isParent ? '' : 'container-fluid mt-4'">
  <app-title-page 
  [title]="'Reclamations'" 
  [breadcrumbs]="[{label: 'Dashboard', url: '/dashboard'}, {label: 'Reclamations'}]">
  </app-title-page>
  <div class="row">
    <div [class]="isParent ? 'col-12 mb-3' : 'col-md-4'">
      <div class="panel reclamations-panel">
        <div class="panel-header">
          <div class="left-reclamation-title">
            <h4>Reclamations</h4>
          </div>
        </div>
        <div class="panel-body">
          <div class="tabs">
            <div class="tab" [class.active]="activeTab === 'received'" (click)="switchTab('received')">
              Received ({{ receivedReclamations.length }})
            </div>
            <div class="tab" [class.active]="activeTab === 'sent'" (click)="switchTab('sent')">
              Sent ({{ sentReclamations.length }})
            </div>
          </div>
          
          <div class="reclamations-list">
            <div class="reclamation-item" [class.resolved]="reclamation.isResolved"
              *ngFor="let reclamation of activeReclamations" (click)="selectReclamation(reclamation)">
              <div class="reclamation-subject">{{ reclamation.subject }}</div>
              <div class="reclamation-content">{{ reclamation.content.substring(0, 100) }}{{ reclamation.content.length > 100 ? '...' : '' }}</div>
              <div class="reclamation-meta">
                <span class="reclamation-date">{{ formatDate(reclamation.sentAt) }}</span>
                <span class="reclamation-status" [class.open]="!reclamation.isResolved" [class.resolved]="reclamation.isResolved">
                  {{ reclamation.isResolved ? 'Resolved' : 'Open' }}
                </span>
              </div>
            </div>
            <div class="empty muted" *ngIf="activeReclamations.length === 0">
              No reclamations found
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div *ngIf="!isParent" class="col-md-8">
      <div class="panel">
        <div class="panel-header">
          <div>New Reclamation</div>
        </div>
        <div class="panel-body reclamation-body">
          <div>
            <div class="input-row" *ngIf="!authService.isParent()">
              <select class="input" [(ngModel)]="newReclamation.recipientId" required>
                <option value="">Select recipient</option>
                <option *ngFor="let user of users" [value]="user.id">
                  {{ user.name }} ({{ user.email }})
                </option>
              </select>
            </div>
            <div class="input-row" style="margin-top: 12px;">
              <input type="text" class="input" placeholder="Subject" [(ngModel)]="newReclamation.subject" required>
            </div>
            <div class="input-row" style="margin-top: 12px;">
              <textarea class="textarea" placeholder="Content" [(ngModel)]="newReclamation.content" required></textarea>
            </div>
            <div class="input-row" style="margin-top: 12px;">
              <button class="send" (click)="send()" [disabled]="(!authService.isParent() && !newReclamation.recipientId) || !newReclamation.subject.trim() || !newReclamation.content.trim()">
                <i class="bi bi-send"></i> Send Reclamation
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div *ngIf="showNewReclamationModal" class="modal-backdrop" (click)="closeNewReclamationModal()"></div>
<div *ngIf="showNewReclamationModal" class="modal">
  <div class="modal-header">
    <h3 class="modal-title">New Reclamation</h3>
    <button class="modal-close" (click)="closeNewReclamationModal()">&times;</button>
  </div>
  <div class="modal-body">
    <div class="input-row" *ngIf="!authService.isParent()">
      <select class="input" [(ngModel)]="newReclamation.recipientId" required>
        <option value="">Select recipient</option>
        <option *ngFor="let user of users" [value]="user.id">
          {{ user.name }} ({{ user.email }})
        </option>
      </select>
    </div>
    <div class="input-row" style="margin-top: 12px;">
      <input type="text" class="input" placeholder="Subject" [(ngModel)]="newReclamation.subject" required>
    </div>
    <div class="input-row" style="margin-top: 12px;">
      <textarea class="textarea" placeholder="Content" [(ngModel)]="newReclamation.content" required></textarea>
    </div>
    <div class="input-row" style="margin-top: 12px;">
      <button class="send" (click)="send()" [disabled]="(!authService.isParent() && !newReclamation.recipientId) || !newReclamation.subject.trim() || !newReclamation.content.trim()">
        <i class="bi bi-send"></i> Send Reclamation
      </button>
    </div>
  </div>
</div>

<div *ngIf="showModal" class="modal-backdrop" (click)="closeModal()"></div>
<div *ngIf="showModal" class="modal">
  <div class="modal-header">
    <h3 class="modal-title">Reclamation Details</h3>
    <button class="modal-close" (click)="closeModal()">&times;</button>
  </div>
  <div class="modal-body">
    <div *ngIf="selectedReclamation">
      <div class="reclamation-header">
        <h3 class="reclamation-title">{{ selectedReclamation.subject }}</h3>
        <div class="reclamation-sender">From: {{ getUserName(selectedReclamation.senderId) }}</div>
        <div class="reclamation-recipient">To: {{ getUserName(selectedReclamation.recipientId) }}</div>
        <div class="reclamation-date-full">Sent: {{ formatDate(selectedReclamation.sentAt) }}</div>
        <div class="reclamation-status" [class.open]="!selectedReclamation.isResolved" [class.resolved]="selectedReclamation.isResolved">
          Status: {{ selectedReclamation.isResolved ? 'Resolved' : 'Open' }}
          <span *ngIf="selectedReclamation.isResolved"> at {{ formatDate(selectedReclamation.resolvedAt) }}</span>
        </div>
      </div>
      
      <div class="reclamation-content-full">
        {{ selectedReclamation.content }}
      </div>
      
      <div class="response-section" *ngIf="selectedReclamation.isResolved && selectedReclamation.response">
        <div class="response-title">Response</div>
        <div class="response-content">
          {{ selectedReclamation.response }}
        </div>
      </div>
      
      <div class="response-section" *ngIf="!selectedReclamation.isResolved && selectedReclamation.recipientId === currentUserId">
        <div class="response-title">Resolve Reclamation</div>
        <textarea class="textarea" placeholder="Enter your response..." [(ngModel)]="responseText"></textarea>
        <div class="input-row" style="margin-top: 12px;">
          <button class="resolve" (click)="resolve()" [disabled]="!responseText.trim()">
            <i class="bi bi-check-circle"></i> Mark as Resolved
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
