<div [class]="isParent ? '' : 'container-fluid mt-4'" >
  <app-title-page 
    title="Attendance Management" 
    [breadcrumbs]="[{label: 'Dashboard', url: '/dashboard'}, {label: 'Attendance'}]">
  </app-title-page>
</div>
<div class="container-fluid mt-4">
  <!-- Live Clock -->
  <div class="row mb-3">
    <div class="col-12">
      <div class="live-clock-card">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h4 class="mb-0">{{ getCurrentTime() }}</h4>
            <small class="text-muted">{{ currentTime | date:'fullDate' }}</small>
          </div>
          <div class="live-indicator">
            <span class="pulse-dot"></span>
            <small>Live</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="stats-card present">
        <div class="stats-icon">
          <i class="bi bi-person-check"></i>
        </div>
        <div class="stats-content">
          <h3>{{ stats.totalPresent }}</h3>
          <p>Present Today</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stats-card absent">
        <div class="stats-icon">
          <i class="bi bi-person-x"></i>
        </div>
        <div class="stats-content">
          <h3>{{ stats.totalAbsent }}</h3>
          <p>Absent Today</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stats-card checkin">
        <div class="stats-icon">
          <i class="bi bi-box-arrow-in-right"></i>
        </div>
        <div class="stats-content">
          <h3>{{ stats.checkInsToday }}</h3>
          <p>Check-ins</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stats-card checkout">
        <div class="stats-icon">
          <i class="bi bi-box-arrow-right"></i>
        </div>
        <div class="stats-content">
          <h3>{{ stats.checkOutsToday }}</h3>
          <p>Check-outs</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Check-in -->
  <div class="card mb-4" *ngIf="selectedDate === (currentTime | date:'yyyy-MM-dd')">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h6 class="mb-0"><i class="bi bi-person-plus"></i> Quick Check-in</h6>
      <button class="btn btn-sm btn-success" (click)="toggleCheckInForm()">
        <i class="bi bi-plus-circle"></i> {{ showCheckInForm ? 'Cancel' : 'Check-in Child' }}
      </button>
    </div>
    <div class="card-body" *ngIf="showCheckInForm">
      <div class="row align-items-end">
        <div class="col-md-4">
          <label class="form-label">Select Child</label>
          <select class="form-select" [(ngModel)]="selectedChildId">
            <option value="">Choose a child...</option>
            <option *ngFor="let child of availableChildren" [value]="child.id">
              {{ child.firstName }} {{ child.lastName }}
            </option>
          </select>
        </div>
        <div class="col-md-5">
          <label class="form-label">Notes (Optional)</label>
          <input type="text" class="form-control" placeholder="Any notes..." [(ngModel)]="checkInNotes">
        </div>
        <div class="col-md-3">
          <button class="btn btn-primary w-100" [disabled]="!selectedChildId" (click)="checkInChild()">
            <i class="bi bi-box-arrow-in-right"></i> Check In
          </button>
        </div>
      </div>
      <div class="mt-2" *ngIf="availableChildren.length === 0">
        <small class="text-muted"><i class="bi bi-info-circle"></i> All children are already checked in today.</small>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="row align-items-center">
        <div class="col-md-4">
          <label class="form-label">Date</label>
          <input type="date" class="form-control" [(ngModel)]="selectedDate" (change)="onDateChange()">
        </div>
        <div class="col-md-4">
          <label class="form-label">Search Child</label>
          <input type="text" class="form-control" placeholder="Search by name..." [(ngModel)]="searchTerm">
        </div>
        <div class="col-md-4 d-flex align-items-end">
          <button class="btn btn-primary" (click)="loadTodayData()">
            <i class="bi bi-arrow-clockwise"></i> Refresh
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Attendance List -->
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Attendance Records</h5>
      <span class="badge bg-primary">{{ filteredAttendances.length }} records</span>
    </div>
    <div class="card-body p-0">
      <div *ngIf="loading" class="text-center p-4">
        <div class="spinner-border" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
      
      <div *ngIf="!loading && filteredAttendances.length === 0" class="text-center p-4 text-muted">
        <i class="bi bi-calendar-x fs-1"></i>
        <p class="mt-2">No attendance records found for this date</p>
      </div>

      <div *ngIf="!loading && filteredAttendances.length > 0" class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>Child</th>
              <th>Parent</th>
              <th>Check-in</th>
              <th>Check-out</th>
              <th>Status</th>
              <th>Duration</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let attendance of filteredAttendances" class="attendance-row">
              <td>
                <div class="d-flex align-items-center">
                  <div class="child-avatar">
                    {{ attendance.child?.firstName?.charAt(0) }}{{ attendance.child?.lastName?.charAt(0) }}
                  </div>
                  <div class="ms-2">
                    <strong>{{ attendance.child?.firstName }} {{ attendance.child?.lastName }}</strong>
                  </div>
                </div>
              </td>
              <td>
                <small class="text-muted">
                  {{ attendance.child?.parent?.firstName }} {{ attendance.child?.parent?.lastName }}
                </small>
              </td>
              <td>
                <div class="time-info">
                  <strong>{{ formatTime(attendance.checkInTime) }}</strong>
                  <small *ngIf="attendance.checkInNotes" class="d-block text-muted">
                    <i class="bi bi-chat-left-text"></i> {{ attendance.checkInNotes }}
                  </small>
                </div>
              </td>
              <td>
                <div *ngIf="attendance.checkOutTime" class="time-info">
                  <strong>{{ formatTime(attendance.checkOutTime) }}</strong>
                  <small *ngIf="attendance.checkOutNotes" class="d-block text-muted">
                    <i class="bi bi-chat-left-text"></i> {{ attendance.checkOutNotes }}
                  </small>
                </div>
                <span *ngIf="!attendance.checkOutTime" class="text-muted">-</span>
              </td>
              <td>
                <span class="status-badge" [class]="getStatusClass(attendance)">
                  {{ getStatusText(attendance) }}
                </span>
              </td>
              <td>
                <span *ngIf="attendance.checkOutTime" class="text-muted">
                  {{ calculateDuration(attendance.checkInTime, attendance.checkOutTime) | number:'1.1-1' }}h
                </span>
                <span *ngIf="!attendance.checkOutTime" class="text-success live-duration">
                  <i class="bi bi-clock"></i> {{ getActiveDuration(attendance.checkInTime) }}
                </span>
              </td>
              <td>
                <button 
                  *ngIf="!attendance.checkOutTime" 
                  class="btn btn-sm btn-outline-danger"
                  (click)="checkOut(attendance)">
                  <i class="bi bi-box-arrow-right"></i> Check Out
                </button>
                <span *ngIf="attendance.checkOutTime" class="text-muted">Completed</span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>
