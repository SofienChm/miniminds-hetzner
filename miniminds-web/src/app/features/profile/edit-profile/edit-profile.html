<div *ngIf="isParent()">
  <app-parent-child-header
    title="Edit profile"
    [children]="[{firstName: profileForm.get('firstName')?.value, lastName: profileForm.get('lastName')?.value, profilePicture: imagePreview}]"
    [currentChildIndex]="0"
    [showDatePicker]="false"
    [showSettings]="true"
    (onBack)="back()"
    >
  </app-parent-child-header>
  <div class="body container-fluid">
    <div class="main-information">
      <!-- Personal Info Tab -->
      <div class="card card-general">
        <div class="card-header">
          <h5>Personal Information</h5>
        </div>
        <div class="card-body">
          <form [formGroup]="profileForm" (ngSubmit)="updateProfile()">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">First Name *</label>
                <input type="text" class="form-control" formControlName="firstName" 
                       [class.is-invalid]="firstName.invalid && firstName.touched">
                <div class="invalid-feedback" *ngIf="firstName.invalid && firstName.touched">
                  {{ getErrorMessage(profileForm, 'firstName') }}
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Last Name *</label>
                <input type="text" class="form-control" formControlName="lastName"
                       [class.is-invalid]="lastName.invalid && lastName.touched">
                <div class="invalid-feedback" *ngIf="lastName.invalid && lastName.touched">
                  {{ getErrorMessage(profileForm, 'lastName') }}
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Email *</label>
                <input type="email" class="form-control" formControlName="email"
                       [class.is-invalid]="email.invalid && email.touched">
                <div class="invalid-feedback" *ngIf="email.invalid && email.touched">
                  {{ getErrorMessage(profileForm, 'email') }}
                </div>
              </div>
              <div class="col-md-6 mb-3" *ngIf="isParent()">
                <label class="form-label">Phone Number *</label>
                <input type="text" class="form-control" formControlName="phoneNumber"
                       [class.is-invalid]="phoneNumber.invalid && phoneNumber.touched">
                <div class="invalid-feedback" *ngIf="phoneNumber.invalid && phoneNumber.touched">
                  {{ getErrorMessage(profileForm, 'phoneNumber') }}
                </div>
              </div>
              <div class="col-md-6 mb-3" *ngIf="isParent()">
                <label class="form-label">Address</label>
                <input type="text" class="form-control" formControlName="address">
              </div>
              <div class="col-md-6 mb-3" *ngIf="isParent()">
                <label class="form-label">Emergency Contact</label>
                <input type="text" class="form-control" formControlName="emergencyContact">
              </div>
              <div class="col-md-6 mb-3" *ngIf="!isParent()">
                <label class="form-label">Role</label>
                <input type="text" class="form-control" [value]="userRole" disabled>
                <small class="text-muted">Role cannot be changed</small>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Profile Picture</label>
                <input type="file" class="form-control" (change)="onImageSelect($event)" accept="image/*">
              </div>
            </div>

            <div *ngIf="errorMessage" class="alert alert-danger">{{ errorMessage }}</div>

            <div class="d-flex gap-2 justify-content-end">
              <button type="submit" class="btn btn-primary btn-add-global" [disabled]="saving || profileForm.invalid">
                <span *ngIf="saving" class="spinner-border spinner-border-sm me-2"></span>
                {{ saving ? 'Updating...' : 'Update Profile' }}
              </button>
              <button type="button" class="btn btn-secondary btn-cancel-global" (click)="cancel()" [disabled]="saving">Cancel</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Security Tab -->
      <div class="card card-general">
        <div class="card-header">
          <h5>Security Settings</h5>
        </div>
        <div class="card-body">
          <p class="text-muted">Change your password and manage security settings</p>
          <form [formGroup]="securityForm" (ngSubmit)="updatePassword()">
            <div class="mb-3">
              <label class="form-label">Current Password *</label>
              <input type="password" class="form-control" formControlName="currentPassword"
                     [class.is-invalid]="securityForm.get('currentPassword')?.invalid && securityForm.get('currentPassword')?.touched"
                     placeholder="Enter current password">
              <div class="invalid-feedback" *ngIf="securityForm.get('currentPassword')?.invalid && securityForm.get('currentPassword')?.touched">
                {{ getErrorMessage(securityForm, 'currentPassword') }}
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">New Password *</label>
              <input type="password" class="form-control" formControlName="newPassword"
                     [class.is-invalid]="securityForm.get('newPassword')?.invalid && securityForm.get('newPassword')?.touched"
                     placeholder="Enter new password">
              <div class="invalid-feedback" *ngIf="securityForm.get('newPassword')?.invalid && securityForm.get('newPassword')?.touched">
                {{ getErrorMessage(securityForm, 'newPassword') }}
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Confirm Password *</label>
              <input type="password" class="form-control" formControlName="confirmPassword"
                     [class.is-invalid]="securityForm.get('confirmPassword')?.invalid && securityForm.get('confirmPassword')?.touched"
                     placeholder="Confirm new password">
              <div class="invalid-feedback" *ngIf="securityForm.get('confirmPassword')?.invalid && securityForm.get('confirmPassword')?.touched">
                {{ getErrorMessage(securityForm, 'confirmPassword') }}
              </div>
            </div>
            <button type="submit" class="btn btn-primary float-right btn-add-global" [disabled]="securityForm.invalid">Update Password</button>
          </form>
        </div>
      </div>

      <!-- Preferences Tab -->
      <div class="card card-general">
        <div class="card-header">
          <h5>Preferences</h5>
        </div>
        <div class="card-body">
          <p class="text-muted">Customize your experience</p>
          <form [formGroup]="preferencesForm" (ngSubmit)="updatePreferences()">
            <div class="mb-3">
              <label class="form-label">Language</label>
              <select class="form-select" formControlName="language">
                <option value="en">English</option>
                <option value="fr">French</option>
                <option value="es">Spanish</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Timezone</label>
              <select class="form-select" formControlName="timezone">
                <option value="UTC">UTC</option>
                <option value="EST">EST</option>
                <option value="PST">PST</option>
              </select>
            </div>
            <button type="submit" class="btn btn-primary btn-add-global float-right">Save Preferences</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="container mt-4" *ngIf="!isParent()">
  <app-title-page *ngIf="!isParent()"
    title="Profile" 
    subtitle="Manage your personal information"
    icon="bi bi-person-circle"
    [breadcrumbs]="breadcrumbs">
  </app-title-page>

  <div class="row">
    <!-- Left Sidebar -->
    <div class="col-md-3">
      <div class="card text-center" *ngIf="!isParent()">
        <div class="card-body">
          <div *ngIf="imagePreview; else defaultPhoto" class="mb-3">
            <img loading="lazy" [src]="imagePreview" class="rounded-circle" width="120" height="120" alt="Profile">
          </div>
          <ng-template #defaultPhoto>
            <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-3" 
                 style="width: 120px; height: 120px; font-size: 48px;">
              {{ getInitials() }}
            </div>
          </ng-template>
          <h5>{{ profileForm.get('firstName')?.value }} {{ profileForm.get('lastName')?.value }}</h5>
          <p class="text-muted">{{ userRole }}</p>
        </div>
      </div>

      <div class="list-group mt-3">
        <a class="list-group-item list-group-item-action" 
           [class.active]="activeTab === 'personal'"
           (click)="setActiveTab('personal')">
          <i class="bi bi-person me-2"></i>Personal Info
        </a>
        <a class="list-group-item list-group-item-action" 
           [class.active]="activeTab === 'security'"
           (click)="setActiveTab('security')">
          <i class="bi bi-shield-lock me-2"></i>Security
        </a>
        <a class="list-group-item list-group-item-action" 
           [class.active]="activeTab === 'preferences'"
           (click)="setActiveTab('preferences')">
          <i class="bi bi-gear me-2"></i>Preferences
        </a>
      </div>
    </div>

    <!-- Right Content -->
    <div class="col-md-9">
      <!-- Personal Info Tab -->
      <div *ngIf="activeTab === 'personal'" class="card card-general">
        <div class="card-header">
          <h5>Personal Information</h5>
        </div>
        <div class="card-body">
          <form [formGroup]="profileForm" (ngSubmit)="updateProfile()">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">First Name *</label>
                <input type="text" class="form-control" formControlName="firstName" 
                       [class.is-invalid]="firstName.invalid && firstName.touched">
                <div class="invalid-feedback" *ngIf="firstName.invalid && firstName.touched">
                  {{ getErrorMessage(profileForm, 'firstName') }}
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Last Name *</label>
                <input type="text" class="form-control" formControlName="lastName"
                       [class.is-invalid]="lastName.invalid && lastName.touched">
                <div class="invalid-feedback" *ngIf="lastName.invalid && lastName.touched">
                  {{ getErrorMessage(profileForm, 'lastName') }}
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Email *</label>
                <input type="email" class="form-control" formControlName="email"
                       [class.is-invalid]="email.invalid && email.touched">
                <div class="invalid-feedback" *ngIf="email.invalid && email.touched">
                  {{ getErrorMessage(profileForm, 'email') }}
                </div>
              </div>
              <div class="col-md-6 mb-3" *ngIf="isParent()">
                <label class="form-label">Phone Number *</label>
                <input type="text" class="form-control" formControlName="phoneNumber"
                       [class.is-invalid]="phoneNumber.invalid && phoneNumber.touched">
                <div class="invalid-feedback" *ngIf="phoneNumber.invalid && phoneNumber.touched">
                  {{ getErrorMessage(profileForm, 'phoneNumber') }}
                </div>
              </div>
              <div class="col-md-6 mb-3" *ngIf="isParent()">
                <label class="form-label">Address</label>
                <input type="text" class="form-control" formControlName="address">
              </div>
              <div class="col-md-6 mb-3" *ngIf="isParent()">
                <label class="form-label">Emergency Contact</label>
                <input type="text" class="form-control" formControlName="emergencyContact">
              </div>
              <div class="col-md-6 mb-3" *ngIf="!isParent()">
                <label class="form-label">Role</label>
                <input type="text" class="form-control" [value]="userRole" disabled>
                <small class="text-muted">Role cannot be changed</small>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Profile Picture</label>
                <input type="file" class="form-control" (change)="onImageSelect($event)" accept="image/*">
              </div>
            </div>

            <div *ngIf="errorMessage" class="alert alert-danger">{{ errorMessage }}</div>

            <div class="d-flex gap-2 justify-content-end">
              <button type="submit" class="btn btn-primary btn-add-global" [disabled]="saving || profileForm.invalid">
                <span *ngIf="saving" class="spinner-border spinner-border-sm me-2"></span>
                {{ saving ? 'Updating...' : 'Update Profile' }}
              </button>
              <button type="button" class="btn btn-secondary btn-cancel-global" (click)="cancel()" [disabled]="saving">Cancel</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Security Tab -->
      <div *ngIf="activeTab === 'security'" class="card card-general">
        <div class="card-header">
          <h5>Security Settings</h5>
        </div>
        <div class="card-body">
          <p class="text-muted">Change your password and manage security settings</p>
          <form [formGroup]="securityForm" (ngSubmit)="updatePassword()">
            <div class="mb-3">
              <label class="form-label">Current Password *</label>
              <input type="password" class="form-control" formControlName="currentPassword"
                     [class.is-invalid]="securityForm.get('currentPassword')?.invalid && securityForm.get('currentPassword')?.touched"
                     placeholder="Enter current password">
              <div class="invalid-feedback" *ngIf="securityForm.get('currentPassword')?.invalid && securityForm.get('currentPassword')?.touched">
                {{ getErrorMessage(securityForm, 'currentPassword') }}
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">New Password *</label>
              <input type="password" class="form-control" formControlName="newPassword"
                     [class.is-invalid]="securityForm.get('newPassword')?.invalid && securityForm.get('newPassword')?.touched"
                     placeholder="Enter new password">
              <div class="invalid-feedback" *ngIf="securityForm.get('newPassword')?.invalid && securityForm.get('newPassword')?.touched">
                {{ getErrorMessage(securityForm, 'newPassword') }}
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Confirm Password *</label>
              <input type="password" class="form-control" formControlName="confirmPassword"
                     [class.is-invalid]="securityForm.get('confirmPassword')?.invalid && securityForm.get('confirmPassword')?.touched"
                     placeholder="Confirm new password">
              <div class="invalid-feedback" *ngIf="securityForm.get('confirmPassword')?.invalid && securityForm.get('confirmPassword')?.touched">
                {{ getErrorMessage(securityForm, 'confirmPassword') }}
              </div>
            </div>
            <button type="submit" class="btn btn-primary float-right btn-add-global" [disabled]="securityForm.invalid">Update Password</button>
          </form>
        </div>
      </div>

      <!-- Preferences Tab -->
      <div *ngIf="activeTab === 'preferences'" class="card card-general">
        <div class="card-header">
          <h5>Preferences</h5>
        </div>
        <div class="card-body">
          <p class="text-muted">Customize your experience</p>
          <form [formGroup]="preferencesForm" (ngSubmit)="updatePreferences()">
            <div class="mb-3">
              <label class="form-label">Language</label>
              <select class="form-select" formControlName="language">
                <option value="en">English</option>
                <option value="fr">French</option>
                <option value="es">Spanish</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Timezone</label>
              <select class="form-select" formControlName="timezone">
                <option value="UTC">UTC</option>
                <option value="EST">EST</option>
                <option value="PST">PST</option>
              </select>
            </div>
            <button type="submit" class="btn btn-primary btn-add-global float-right">Save Preferences</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
