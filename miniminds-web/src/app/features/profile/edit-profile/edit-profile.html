<div *ngIf="isParent()">
  <app-parent-child-header
    title="Edit profile"
    [children]="[{firstName: profileForm.get('firstName')?.value, lastName: profileForm.get('lastName')?.value, profilePicture: imagePreview}]"
    [currentChildIndex]="0"
    [showDatePicker]="false"
    [showSettings]="true"
    (onBack)="back()"
    >
  </app-parent-child-header>
  <div class="body container-fluid">
    <div class="main-information">
      <!-- Personal Info Tab -->
      <div class="card card-general">
        <div class="card-header">
          <h5>Personal Information</h5>
        </div>
        <div class="card-body">
          <form [formGroup]="profileForm" (ngSubmit)="updateProfile()">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">First Name *</label>
                <input type="text" class="form-control" formControlName="firstName" 
                       [class.is-invalid]="firstName.invalid && firstName.touched">
                <div class="invalid-feedback" *ngIf="firstName.invalid && firstName.touched">
                  {{ getErrorMessage(profileForm, 'firstName') }}
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Last Name *</label>
                <input type="text" class="form-control" formControlName="lastName"
                       [class.is-invalid]="lastName.invalid && lastName.touched">
                <div class="invalid-feedback" *ngIf="lastName.invalid && lastName.touched">
                  {{ getErrorMessage(profileForm, 'lastName') }}
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Email *</label>
                <input type="email" class="form-control" formControlName="email"
                       [class.is-invalid]="email.invalid && email.touched">
                <div class="invalid-feedback" *ngIf="email.invalid && email.touched">
                  {{ getErrorMessage(profileForm, 'email') }}
                </div>
              </div>
              <div class="col-md-6 mb-3" *ngIf="isParent()">
                <label class="form-label">Phone Number *</label>
                <input type="text" class="form-control" formControlName="phoneNumber"
                       [class.is-invalid]="phoneNumber.invalid && phoneNumber.touched">
                <div class="invalid-feedback" *ngIf="phoneNumber.invalid && phoneNumber.touched">
                  {{ getErrorMessage(profileForm, 'phoneNumber') }}
                </div>
              </div>
              <div class="col-md-6 mb-3" *ngIf="isParent()">
                <label class="form-label">Address</label>
                <input type="text" class="form-control" formControlName="address">
              </div>
              <div class="col-md-6 mb-3" *ngIf="isParent()">
                <label class="form-label">Emergency Contact</label>
                <input type="text" class="form-control" formControlName="emergencyContact">
              </div>
              <div class="col-md-6 mb-3" *ngIf="!isParent()">
                <label class="form-label">Role</label>
                <input type="text" class="form-control" [value]="userRole" disabled>
                <small class="text-muted">Role cannot be changed</small>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Profile Picture</label>
                <input type="file" class="form-control" (change)="onImageSelect($event)" accept="image/*">
              </div>
            </div>

            <div *ngIf="errorMessage" class="alert alert-danger">{{ errorMessage }}</div>

            <div class="d-flex gap-2 justify-content-end">
              <button type="submit" class="btn btn-primary btn-add-global" [disabled]="saving || profileForm.invalid">
                <span *ngIf="saving" class="spinner-border spinner-border-sm me-2"></span>
                {{ saving ? 'Updating...' : 'Update Profile' }}
              </button>
              <button type="button" class="btn btn-secondary btn-cancel-global" (click)="cancel()" [disabled]="saving">Cancel</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Security Tab -->
      <div class="card card-general">
        <div class="card-header">
          <h5>Security Settings</h5>
        </div>
        <div class="card-body">
          <p class="text-muted">Change your password and manage security settings</p>
          <form [formGroup]="securityForm" (ngSubmit)="updatePassword()">
            <div class="mb-3">
              <label class="form-label">Current Password *</label>
              <input type="password" class="form-control" formControlName="currentPassword"
                     [class.is-invalid]="securityForm.get('currentPassword')?.invalid && securityForm.get('currentPassword')?.touched"
                     placeholder="Enter current password">
              <div class="invalid-feedback" *ngIf="securityForm.get('currentPassword')?.invalid && securityForm.get('currentPassword')?.touched">
                {{ getErrorMessage(securityForm, 'currentPassword') }}
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">New Password *</label>
              <input type="password" class="form-control" formControlName="newPassword"
                     [class.is-invalid]="securityForm.get('newPassword')?.invalid && securityForm.get('newPassword')?.touched"
                     placeholder="Enter new password">
              <div class="invalid-feedback" *ngIf="securityForm.get('newPassword')?.invalid && securityForm.get('newPassword')?.touched">
                {{ getErrorMessage(securityForm, 'newPassword') }}
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Confirm Password *</label>
              <input type="password" class="form-control" formControlName="confirmPassword"
                     [class.is-invalid]="securityForm.get('confirmPassword')?.invalid && securityForm.get('confirmPassword')?.touched"
                     placeholder="Confirm new password">
              <div class="invalid-feedback" *ngIf="securityForm.get('confirmPassword')?.invalid && securityForm.get('confirmPassword')?.touched">
                {{ getErrorMessage(securityForm, 'confirmPassword') }}
              </div>
            </div>
            <button type="submit" class="btn btn-primary float-right btn-add-global" [disabled]="securityForm.invalid">Update Password</button>
          </form>
        </div>
      </div>

      <!-- Preferences Tab -->
      <div class="card card-general">
        <div class="card-header">
          <h5>Preferences</h5>
        </div>
        <div class="card-body">
          <p class="text-muted">Customize your experience</p>
          <form [formGroup]="preferencesForm" (ngSubmit)="updatePreferences()">
            <div class="mb-3">
              <label class="form-label">Language</label>
              <select class="form-select" formControlName="language">
                <option value="en">English</option>
                <option value="fr">French</option>
                <option value="es">Spanish</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Timezone</label>
              <select class="form-select" formControlName="timezone">
                <option value="UTC">UTC</option>
                <option value="EST">EST</option>
                <option value="PST">PST</option>
              </select>
            </div>
            <button type="submit" class="btn btn-primary btn-add-global float-right">Save Preferences</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="container-fluid mt-4" *ngIf="!isParent()">
  <app-title-page
    [title]="'EDIT_PROFILE.TITLE' | translate"
    [subtitle]="'EDIT_PROFILE.SUBTITLE' | translate"
    icon="bi bi-person-circle"
    [breadcrumbs]="breadcrumbs">
  </app-title-page>

  <!-- Profile Picture Card -->
   <div class="row">
    <div class="col-4">
      <div class="card card-general shadow-sm">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-person-circle"></i>{{ 'EDIT_PROFILE.PROFILE_PICTURE' | translate }}</h5>
        </div>
        <div class="card-body text-center">
          <div class="profile-picture-container">
            <div *ngIf="imagePreview; else defaultPhoto" class="profile-picture-wrapper">
              <img loading="lazy" [src]="imagePreview" class="rounded-circle profile-picture" alt="Profile">
            </div>
            <ng-template #defaultPhoto>
              <div class="profile-initials rounded-circle d-inline-flex align-items-center justify-content-center">
                {{ getInitials() }}
              </div>
            </ng-template>
            <button type="button" class="btn-add-photo" (click)="openPhotoModal()">
              <i class="bi bi-plus-lg"></i>
            </button>
          </div>
          <h5 class="mt-3">{{ profileForm.get('firstName')?.value }} {{ profileForm.get('lastName')?.value }}</h5>
          <p class="text-muted mb-0">{{ userRole }}</p>
        </div>
      </div>
    </div>
    <div class="col-8">
      <!-- Personal Info Card -->
      <div class="card card-general shadow-sm">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-person-fill"></i>{{ 'EDIT_PROFILE.PERSONAL_INFO' | translate }}</h5>
        </div>
        <div class="card-body">
          <form [formGroup]="profileForm" (ngSubmit)="updateProfile()">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">{{ 'EDIT_PROFILE.FIRST_NAME' | translate }} {{ 'EDIT_PROFILE.REQUIRED' | translate }}</label>
                <input type="text" class="form-control" formControlName="firstName"
                      [class.is-invalid]="firstName.invalid && firstName.touched">
                <div class="invalid-feedback" *ngIf="firstName.invalid && firstName.touched">
                  {{ getErrorMessage(profileForm, 'firstName') }}
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">{{ 'EDIT_PROFILE.LAST_NAME' | translate }} {{ 'EDIT_PROFILE.REQUIRED' | translate }}</label>
                <input type="text" class="form-control" formControlName="lastName"
                      [class.is-invalid]="lastName.invalid && lastName.touched">
                <div class="invalid-feedback" *ngIf="lastName.invalid && lastName.touched">
                  {{ getErrorMessage(profileForm, 'lastName') }}
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">{{ 'EDIT_PROFILE.EMAIL' | translate }} {{ 'EDIT_PROFILE.REQUIRED' | translate }}</label>
                <input type="email" class="form-control" formControlName="email"
                      [class.is-invalid]="email.invalid && email.touched">
                <div class="invalid-feedback" *ngIf="email.invalid && email.touched">
                  {{ getErrorMessage(profileForm, 'email') }}
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">{{ 'EDIT_PROFILE.ROLE' | translate }}</label>
                <input type="text" class="form-control" [value]="userRole" disabled>
                <small class="text-muted">{{ 'EDIT_PROFILE.ROLE_HINT' | translate }}</small>
              </div>
            </div>

            <div *ngIf="errorMessage" class="alert alert-danger">{{ errorMessage }}</div>

            <div class="d-flex gap-2 justify-content-end">
              <button type="button" class="custom-btn-2 btn-cancel-2" (click)="cancel()" [disabled]="saving">{{ 'EDIT_PROFILE.CANCEL' | translate }}</button>
              <button type="submit" class="custom-btn-2 btn-add-global-2" [disabled]="saving || profileForm.invalid">
                <span *ngIf="saving" class="spinner-border spinner-border-sm me-2"></span>
                <i class="bi bi-check-circle me-2" *ngIf="!saving"></i>
                {{ saving ? ('EDIT_PROFILE.UPDATING' | translate) : ('EDIT_PROFILE.UPDATE_PROFILE' | translate) }}
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Security Card -->
      <div class="card card-general shadow-sm">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-shield-lock-fill"></i>{{ 'EDIT_PROFILE.SECURITY_SETTINGS' | translate }}</h5>
        </div>
        <div class="card-body">
          <p class="text-muted">{{ 'EDIT_PROFILE.SECURITY_DESC' | translate }}</p>
          <form [formGroup]="securityForm" (ngSubmit)="updatePassword()">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">{{ 'EDIT_PROFILE.CURRENT_PASSWORD' | translate }} {{ 'EDIT_PROFILE.REQUIRED' | translate }}</label>
                <input type="password" class="form-control" formControlName="currentPassword"
                      [class.is-invalid]="securityForm.get('currentPassword')?.invalid && securityForm.get('currentPassword')?.touched"
                      [placeholder]="'EDIT_PROFILE.CURRENT_PASSWORD_PLACEHOLDER' | translate">
                <div class="invalid-feedback" *ngIf="securityForm.get('currentPassword')?.invalid && securityForm.get('currentPassword')?.touched">
                  {{ getErrorMessage(securityForm, 'currentPassword') }}
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">{{ 'EDIT_PROFILE.NEW_PASSWORD' | translate }} {{ 'EDIT_PROFILE.REQUIRED' | translate }}</label>
                <input type="password" class="form-control" formControlName="newPassword"
                      [class.is-invalid]="securityForm.get('newPassword')?.invalid && securityForm.get('newPassword')?.touched"
                      [placeholder]="'EDIT_PROFILE.NEW_PASSWORD_PLACEHOLDER' | translate">
                <div class="invalid-feedback" *ngIf="securityForm.get('newPassword')?.invalid && securityForm.get('newPassword')?.touched">
                  {{ getErrorMessage(securityForm, 'newPassword') }}
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">{{ 'EDIT_PROFILE.CONFIRM_PASSWORD' | translate }} {{ 'EDIT_PROFILE.REQUIRED' | translate }}</label>
                <input type="password" class="form-control" formControlName="confirmPassword"
                      [class.is-invalid]="securityForm.get('confirmPassword')?.invalid && securityForm.get('confirmPassword')?.touched"
                      [placeholder]="'EDIT_PROFILE.CONFIRM_PASSWORD_PLACEHOLDER' | translate">
                <div class="invalid-feedback" *ngIf="securityForm.get('confirmPassword')?.invalid && securityForm.get('confirmPassword')?.touched">
                  {{ getErrorMessage(securityForm, 'confirmPassword') }}
                </div>
              </div>
            </div>
            <div class="d-flex justify-content-end">
              <button type="submit" class="custom-btn-2 btn-add-global-2" [disabled]="securityForm.invalid">
                <i class="bi bi-check-circle me-2"></i>
                {{ 'EDIT_PROFILE.UPDATE_PASSWORD' | translate }}
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Preferences Card -->
      <div class="card card-general shadow-sm">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-gear-fill"></i>{{ 'EDIT_PROFILE.PREFERENCES' | translate }}</h5>
        </div>
        <div class="card-body">
          <p class="text-muted">{{ 'EDIT_PROFILE.PREFERENCES_DESC' | translate }}</p>
          <form [formGroup]="preferencesForm" (ngSubmit)="updatePreferences()">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">{{ 'EDIT_PROFILE.LANGUAGE' | translate }}</label>
                <ng-select
                  formControlName="language"
                  [items]="languages"
                  bindLabel="name"
                  bindValue="code"
                  [clearable]="false"
                  [searchable]="false"
                  (change)="switchLanguage($event?.code)">
                  <ng-template ng-label-tmp let-item="item">
                    <span>{{ item.flag }} {{ item.name }}</span>
                  </ng-template>
                  <ng-template ng-option-tmp let-item="item">
                    <span>{{ item.flag }} {{ item.name }}</span>
                  </ng-template>
                </ng-select>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">{{ 'EDIT_PROFILE.TIMEZONE' | translate }}</label>
                <select class="form-select" formControlName="timezone">
                  <option value="UTC">UTC</option>
                  <option value="EST">EST</option>
                  <option value="PST">PST</option>
                </select>
              </div>
            </div>
            <div class="d-flex justify-content-end">
              <button type="submit" class="custom-btn-2 btn-add-global-2">
                <i class="bi bi-floppy me-2"></i>
                {{ 'EDIT_PROFILE.SAVE_PREFERENCES' | translate }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
   </div>

  <!-- Hidden file input for image upload -->
  <input type="file" #fileInput class="d-none" (change)="onImageSelect($event)" accept="image/*">

  <!-- Image Cropper Modal -->
  <app-image-cropper-modal
    #imageCropper
    [imageFile]="selectedImageFile"
    [aspectRatio]="1"
    [roundCropper]="true"
    [resizeToWidth]="300"
    [resizeToHeight]="300"
    (imageCropped)="onImageCropped($event)"
    (cancelled)="onCropCancelled()">
  </app-image-cropper-modal>
</div>
