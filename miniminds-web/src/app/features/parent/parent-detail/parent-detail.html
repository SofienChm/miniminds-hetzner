<div *ngIf="isParent">
  <div *ngIf="parent && !loading" class="parent-detailchild font-inter">
    <app-parent-child-header
      title="Parent profile"
      [children]="[parent]"
      [currentChildIndex]="0"
      [hasCustomContent]="true"
      (onBack)="back()"
      [showEdit]="true"
      (onEdit)="editParent()">
      <div headerCard>
        <span class="badge logout d-inline-flex align-items-center mb-2" >
          <i class="bi bi-box-arrow-left" (click)="logout()" style="cursor: pointer;"></i>
        Logout
        </span>

        <div>
          <div class="info-title">Registration Date</div>
          <div class="info-desc">{{ parent.createdAt | date:'yy/MM/dd' }}</div>
        </div>
      </div>
    </app-parent-child-header>
      <div class="body container-fluid ">

        <div class="other-information">
          <h5 class="title-body">
            Children Information
          </h5>
          <div *ngFor="let child of parent.children" class="profile-info-card_parent mb-3">
            <div class="d-flex gap-3 align-items-center">
              <div class="info-image">
                <img [src]="child.profilePicture || 'assets/default-avatar.svg'" 
                    class="img-fluid" alt="Child Photo">
              </div>
              <div class="info">
                <div class="info-title">{{ child.firstName }} {{ child.lastName }}</div>
                <div class="info-desc">{{ child.age }} years old</div>
              </div>
              <div class="link" (click)="viewChildDetails(child.id)">
                <i class="bi bi-chevron-right"></i>
              </div>
            </div>
          </div>
        </div>
        <div class="main-information">
          <h5 class="title-body">
            Basic Information
          </h5>
          <div class="profile-info-grid">
            <div  class="profile-info-card">
              <div >
                <div class="info-title">Emergency Contact</div>
                <div class="info-desc">{{ parent.emergencyContact }}</div>
              </div>
            </div>
            <div  class="profile-info-card">
              <div >
                <div class="info-title">Phone Number</div>
                <div class="info-desc">{{ parent.phoneNumber }}</div>
              </div>
            </div>
            <div  class="profile-info-card birthday">
              <span class="icon">ðŸ‘¤</span>
              <div >
                <div class="info-title">Birthday</div>
                <div class="info-desc">{{ parent.dateOfBirth ? (parent.dateOfBirth | date:'yy/MM/dd') : 'N/A' }}</div>
              </div>
            </div>
            <div  class="profile-info-card">
              <div >
                <div class="info-title">Gender</div>
                <div class="info-desc">{{ parent.gender || 'N/A' }}</div>
              </div>
            </div>
            <div  class="profile-info-card">
              <div >
                <div class="info-title">Email</div>
                <div class="info-desc">{{ parent.email }}</div>
              </div>
            </div>
            <div  class="profile-info-card">
              <div >
                <div class="info-title">Address</div>
                <div class="info-desc">{{ parent.address || 'N/A' }}</div>
              </div>
            </div>
            <div class="profile-info-card">
              <div >
                <div class="info-title">work</div>
                <div class="info-desc">{{ parent.work}}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
</div>

<div class="container mt-4">
<app-title-page *ngIf="!isParent" 
  [title]="'Parent Details'"
  [breadcrumbs]="[
    { label: 'Dashboard', url: '/dashboard' },
    { label: 'Parents', url: '/parents' },
    { label: 'Details' }
  ]"
  [actions]="getActions()">
</app-title-page>

  <div *ngIf="loading" class="text-center">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <div *ngIf="error" class="alert alert-danger">
    {{ error }}
  </div>

  <div *ngIf="parent && !loading && !isParent" class="row">
    <div class="col-md-6">
      <div class="card card-parent_detail card-detail_pages">
        <div class="card-header">
          <div class="d-flex align-items-center flex-wrap row-gap-2 row_direction">                                                
            <div class="d-flex align-items-center justify-content-center avatar avatar-xxl border border-dashed me-2 flex-shrink-0 text-dark frames">
              <img loading="lazy"   
                  [src]="parent.profilePicture || 'assets/default-avatar.svg'" 
                class="img-fluid" alt="Parent Photo">
              <span *ngIf="parent.isActive" class="badge badge-active d-inline-flex align-items-center mb-2"><i class="ti ti-circle-filled fs-5 me-1"></i>Active</span>
              <span *ngIf="!parent.isActive" class="badge badge-inactive d-inline-flex align-items-center mb-2"><i class="ti ti-circle-filled fs-5 me-1"></i>Inactive</span>
            </div>                                              
            <div class="overflow-hidden">
              <h5 class="mb-1 text-truncate">{{ parent.firstName }} {{ parent.lastName }}</h5>
              <p class="age">Parent</p>
            </div>
          </div>
        </div>

        <!-- Basic Information -->
        <div class="card-body">
          <h5 class="mb-3 title-body">Basic Information</h5>
          <dl class="row mb-0 table"> 
            <dt class="col-6 fw-medium text-dark mb-3">Full name</dt> 
            <dd class="col-6 mb-3">{{ parent.firstName }} {{ parent.lastName }}</dd> 
            <dt class="col-6 fw-medium text-dark mb-3">Gender</dt> 
            <dd class="col-6 mb-3">{{ parent.gender || 'N/A' }}</dd> 
            <dt class="col-6 fw-medium text-dark mb-3">Date Of Birth</dt> 
            <dd class="col-6 mb-3">{{ parent.dateOfBirth ? (parent.dateOfBirth | date:'yy/MM/dd') : 'N/A' }}</dd> 
            <dt class="col-6 fw-medium text-dark mb-3">Email</dt> 
            <dd class="col-6 mb-3">{{ parent.email }}</dd> 
            <dt class="col-6 fw-medium text-dark mb-3">Phone Number</dt> 
            <dd class="col-6 mb-3">{{ parent.phoneNumber }}</dd> 
            <dt class="col-6 fw-medium text-dark mb-3">Registration Date</dt> 
            <dd class="col-6 mb-3">{{ formatDate(parent.createdAt) }}</dd> 
          </dl>
          <button (click)="addChild()" class="btn btn-primary btn-sm w-100">Add Child</button>
        </div>

        <!-- /Basic Information -->

      </div>
       <div class="card mt-3 global-card" *ngIf="parent.address">
        <div class="card-header">
          <h5>Address Information</h5>
        </div>
        <div class="card-body">
          <div class="row mb-3">
            <div class="col-sm-4"><strong>Address:</strong></div>
            <div class="col-sm-8">{{ parent.address }}</div>
          </div>
          <div class="row mb-3" *ngIf="parent.zipCode">
            <div class="col-sm-4"><strong>Zip Code:</strong></div>
            <div class="col-sm-8">{{ parent.zipCode }}</div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card global-card card-children-info">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Children Information</h5>
          <button class="btn btn-sm btn-add-second" (click)="addChild()">
            <i class="bi bi-plus-square me-1"></i>Add Child
          </button>
        </div>
        <div class="card-body">
          <div *ngIf="!parent.children || parent.children.length === 0" class="text-center text-muted">
            <p>No children registered yet.</p>
          </div>
          
          <div *ngFor="let child of parent.children" class="border rounded p-3 pb-0 mb-3">
            <div class="card card-parent_detail card-detail_pages border-white">
              <div class="card-header">
                <div class="d-flex align-items-center flex-wrap row-gap-2">
                  <div class="avatar child-image">
                    <img loading="lazy" 
                      [src]="child.profilePicture || 'assets/default-avatar.svg'" 
                      class="img-fluid" 
                      alt="Child Photo">
                  </div>
                  <div class="ms-2 title-age">
                    <p class="mb-0">
                      <strong>{{ child.firstName }} {{ child.lastName }}</strong>
                    </p>
                    <span class="text-muted">{{ child.age }} years old</span>
                  </div>
                </div>
              </div>
              <div class="card-body">
                <ul class="d-flex align-items-center flex-wrap child-text">
                  <li class="mb-3 me-4">
                    <p class="mb-1">Date of Birth</p>
                    <h6 class="fw-normal">{{ formatDate(child.dateOfBirth) }}</h6>
                  </li>
                  <li class="mb-3 me-4">
                    <p class="mb-1">Gender</p>
                    <h6 class="fw-normal">{{ child.gender }}</h6>
                  </li>
                  <li class="mb-3">
                    <p class="mb-1">Enrollment Date</p>
                    <h6 class="fw-normal">{{ formatDate(child.enrollmentDate) }}</h6>
                  </li>
                </ul>
              </div>
              <div class="card-footer">
                <div class="d-flex col-12 align-items-center justify-content-end action-child">
                  <a class="btn btn-light btn-sm" 
                          (click)="addFeeForChild(child.id, child.firstName + ' ' + child.lastName)">
                    Add Fees
                </a>
                  <a class="btn btn-primary btn-sm" (click)="viewChildDetails(child.id)">
                    View Details
                  </a>
                  <a class="btn btn-danger btn-sm" (click)="removeChildFromParent(child.id, child.firstName + ' ' + child.lastName)">
                    <i class="bi bi-trash3 me-1"></i>Remove
                  </a>
                </div>
              </div>
              
              <!-- Additional child information -->
              <div *ngIf="child.allergies || child.medicalNotes" class="pt-3 pb-3 border-top allergies-medical">
                <div class="row" *ngIf="child.allergies">
                  <div class="col-sm-3 title"><strong>Allergies:</strong></div>
                  <div class="col-sm-9 detail">{{ child.allergies }}</div>
                </div>
                <div class="row mt-2" *ngIf="child.medicalNotes">
                  <div class="col-sm-3 title"><strong>Medical Notes:</strong></div>
                  <div class="col-sm-9 detail">{{ child.medicalNotes }}</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Select Existing Child Modal -->
  <div class="modal fade show d-block" *ngIf="showSelectChildModal" style="background-color: rgba(0,0,0,0.5)" (click)="closeSelectChildModal()">
    <div class="modal-dialog modal-lg modal-dialog-centered sweet-center" (click)="$event.stopPropagation()">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Select Existing Child</h5>
          <button type="button" class="btn-close" (click)="closeSelectChildModal()"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <input 
              type="text" 
              class="form-control" 
              placeholder="Search by name..." 
              [(ngModel)]="searchTerm"
              (ngModelChange)="filterChildren()">
          </div>
          <div *ngIf="filteredChildren.length === 0" class="text-center text-muted py-4">
            <p>No available children found</p>
          </div>
          <div class="list-group" style="max-height: 400px; overflow-y: auto;">
            <button 
              *ngFor="let child of filteredChildren" 
              type="button" 
              class="list-group-item list-group-item-action"
              (click)="linkChildToParent(child.id!)"
              [disabled]="linkingChild">
              <div class="d-flex align-items-center">
                <img loading="lazy" 
                  [src]="child.profilePicture || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4NCiAgPGNpcmNsZSBjeD0iMTAwIiBjeT0iMTAwIiByPSI4MCIgZmlsbD0iI0YwRTY4QyIvPg0KICA8Y2lyY2xlIGN4PSIxMDAiIGN5PSI4NSIgcj0iMjUiIGZpbGw9IndoaXRlIiBvcGFjaXR5PSIwLjkiLz4NCiAgPGVsbGlwc2UgY3g9IjEwMCIgY3k9IjEzNSIgcng9IjQ1IiByeT0iMzUiIGZpbGw9IndoaXRlIiBvcGFjaXR5PSIwLjkiLz4NCiAgPGNpcmNsZSBjeD0iODUiIGN5PSI4MCIgcj0iNSIgZmlsbD0iIzMzMyIvPg0KICA8Y2lyY2xlIGN4PSIxMTUiIGN5PSI4MCIgcj0iNSIgZmlsbD0iIzMzMyIvPg0KICA8cGF0aCBkPSJNIDg1IDk1IFEgMTAwIDEwNSAxMTUgOTUiIHN0cm9rZT0iIzMzMyIgc3Ryb2tlLXdpZHRoPSIyIiBmaWxsPSJub25lIi8+DQo8L3N2Zz4='" 
                  class="rounded-circle me-3" 
                  style="width: 50px; height: 50px;"
                  alt="Child Photo">
                <div class="flex-grow-1">
                  <h6 class="mb-0">{{ child.firstName }} {{ child.lastName }}</h6>
                  <small class="text-muted">DOB: {{ formatDate(child.dateOfBirth) }} | Gender: {{ child.gender }}</small>
                </div>
              </div>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Fee Modal -->
  <div class="modal fade show d-block" *ngIf="showAddFee" style="background-color: rgba(0,0,0,0.5)">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add Fee</h5>
          <button type="button" class="btn-close" (click)="cancelAddFee()"></button>
        </div>
        <div class="modal-body">
          <form (ngSubmit)="saveFee()">
            <div class="mb-3">
              <label class="form-label">Amount *</label>
              <input type="number" class="form-control" [(ngModel)]="newFee.amount" name="amount" required min="0" step="0.01">
            </div>
            <div class="mb-3">
              <label class="form-label">Description *</label>
              <input type="text" class="form-control" [(ngModel)]="newFee.description" name="description" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Due Date *</label>
              <input type="date" class="form-control" [(ngModel)]="newFee.dueDate" name="dueDate" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Fee Type</label>
              <select class="form-select" [(ngModel)]="newFee.feeType" name="feeType">
                <option value="monthly">Monthly</option>
                <option value="one-time">One-time</option>
                <option value="late-fee">Late Fee</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Notes</label>
              <textarea class="form-control" [(ngModel)]="newFee.notes" name="notes" rows="3"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="cancelAddFee()" [disabled]="savingFee">Cancel</button>
          <button type="button" class="btn btn-primary" (click)="saveFee()" [disabled]="savingFee">
            <span *ngIf="savingFee" class="spinner-border spinner-border-sm me-2"></span>
            {{ savingFee ? 'Adding...' : 'Add Fee' }}
          </button>
        </div>
      </div>
    </div>
  </div>
</div>