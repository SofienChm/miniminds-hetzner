<div *ngIf="isParent">
  <div *ngIf="parent && !loading" class="parent-detailchild font-inter">
    <app-parent-child-header title="Parent profile" [children]="[parent]" [currentChildIndex]="0"
      [hasCustomContent]="true" (onBack)="back()" [showEdit]="true" (onEdit)="editParent()">
      <div headerCard>
        <span class="badge logout d-inline-flex align-items-center mb-2">
          <i class="bi bi-box-arrow-left" (click)="logout()" style="cursor: pointer;"></i>
          Logout
        </span>

        <div>
          <div class="info-title">Registration Date</div>
          <div class="info-desc">{{ parent.createdAt | date:'yy/MM/dd' }}</div>
        </div>
      </div>
    </app-parent-child-header>
    <div class="body container-fluid ">

      <div class="other-information">
        <h5 class="title-body">
          Children Information
        </h5>
        <div *ngFor="let child of parent.children" class="profile-info-card_parent mb-3">
          <div class="d-flex gap-3 align-items-center">
            <div class="info-image">
              <img [src]="child.profilePicture || 'assets/default-avatar.svg'" class="img-fluid" alt="Child Photo">
            </div>
            <div class="info">
              <div class="info-title">{{ child.firstName }} {{ child.lastName }}</div>
              <div class="info-desc">{{ child.age }} years old</div>
            </div>
            <div class="link" (click)="viewChildDetails(child.id)">
              <i class="bi bi-chevron-right"></i>
            </div>
          </div>
        </div>
      </div>
      <div class="main-information">
        <h5 class="title-body">
          Basic Information
        </h5>
        <div class="profile-info-grid">
          <div class="profile-info-card">
            <div>
              <div class="info-title">Emergency Contact</div>
              <div class="info-desc">{{ parent.emergencyContact }}</div>
            </div>
          </div>
          <div class="profile-info-card">
            <div>
              <div class="info-title">Phone Number</div>
              <div class="info-desc">{{ parent.phoneNumber }}</div>
            </div>
          </div>
          <div class="profile-info-card birthday">
            <span class="icon">ðŸ‘¤</span>
            <div>
              <div class="info-title">Birthday</div>
              <div class="info-desc">{{ parent.dateOfBirth ? (parent.dateOfBirth | date:'yy/MM/dd') : 'N/A' }}</div>
            </div>
          </div>
          <div class="profile-info-card">
            <div>
              <div class="info-title">Gender</div>
              <div class="info-desc">{{ parent.gender || 'N/A' }}</div>
            </div>
          </div>
          <div class="profile-info-card">
            <div>
              <div class="info-title">Email</div>
              <div class="info-desc">{{ parent.email }}</div>
            </div>
          </div>
          <div class="profile-info-card">
            <div>
              <div class="info-title">Address</div>
              <div class="info-desc">{{ parent.address || 'N/A' }}</div>
            </div>
          </div>
          <div class="profile-info-card">
            <div>
              <div class="info-title">work</div>
              <div class="info-desc">{{ parent.work}}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container-fluid mt-4">
  <app-title-page *ngIf="!isParent" [title]="'Parent Details'" [breadcrumbs]="[
    { label: 'Parents', url: '/parents' },
    { label: 'Details' }
  ]" [actions]="getActions()">
  </app-title-page>

  <div *ngIf="loading" class="text-center">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <div *ngIf="error" class="alert alert-danger">
    {{ error }}
  </div>

  <div *ngIf="parent && !loading && !isParent" class="row mb-4 parent-detail-row">
    <div class="col-md-6" id="parent-detail-section">
      <div class="card card-detail_pages card-general shodown-effect">
        <div class="card card-header pb-0">
          <div class="d-flex align-items-center flex-wrap row-gap-2 row_direction">
            <div
              class="d-flex align-items-center justify-content-center avatar avatar-xxl border border-dashed me-2 flex-shrink-0 text-dark frames">
              <img loading="lazy" [src]="parent.profilePicture || 'assets/default-avatar.svg'" class="img-fluid"
                alt="Parent Photo">
              <span *ngIf="parent.isActive" class="badge badge-active d-inline-flex align-items-center mb-2"><i
                  class="ti ti-circle-filled fs-5 me-1"></i>Active</span>
              <span *ngIf="!parent.isActive" class="badge badge-inactive d-inline-flex align-items-center mb-2"><i
                  class="ti ti-circle-filled fs-5 me-1"></i>Inactive</span>
            </div>
            <div class="overflow-hidden">
              <h5 class="mb-1 text-truncate name-user">{{ parent.firstName }} {{ parent.lastName }}</h5>
              <p class="age">Parent</p>
            </div>
          </div>
        </div>

        <!-- Basic Information grouped into three sections -->
        <div class="card-body grouped-card-body">
          <div class="info-group">
            <h6 class="mb-1 title-body">Basic Information</h6>
            <div class="row">
              <dt class="col-6 title-dt-body-card">Full name</dt>
              <dd class="col-6 description-dt-body-card">{{ parent.firstName }} {{ parent.lastName }}</dd>
              <dt class="col-6 title-dt-body-card">Gender</dt>
              <dd class="col-6 description-dt-body-card">{{ parent.gender || 'N/A' }}</dd>
              <dt class="col-6 title-dt-body-card">Date Of Birth</dt>
              <dd class="col-6 description-dt-body-card">{{ parent.dateOfBirth ? (parent.dateOfBirth | date:'yy/MM/dd')
                : 'N/A' }}</dd>
              <dt class="col-6 title-dt-body-card">Registration Date</dt>
              <dd class="col-6 description-dt-body-card">{{ formatDate(parent.createdAt) }}</dd>
            </div>
          </div>

          <div class="info-group">
            <h6 class="mb-1 title-body">Contact</h6>
            <div class="row">
              <dt class="col-6 title-dt-body-card">Email</dt>
              <dd class="col-6 description-dt-body-card">{{ parent.email }}</dd>
              <dt class="col-6 title-dt-body-card">Phone Number</dt>
              <dd class="col-6 description-dt-body-card">{{ parent.phoneNumber }}</dd>
            </div>
          </div>

          <div class="info-group mb-0" *ngIf="parent.address || parent.zipCode">
            <h6 class="mb-1 title-body">Address</h6>
            <div class="row">
              <div *ngIf="parent.address">
                <dt class="col-6 title-dt-body-card">Address</dt>
                <dd class="col-6 description-dt-body-card">{{ parent.address || 'N/A' }}</dd>
              </div>
              <div *ngIf="parent.zipCode">
                <dt class="col-6 title-dt-body-card">Zip Code</dt>
                <dd class="col-6 description-dt-body-card">{{ parent.zipCode || 'N/A' }}</dd>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <div class="col-md-6" id="children-detail-section">
      <div class="card card-general card-children-info shodown-effect">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Children Information</h5>
          <button class="custom-btn-2 btn-add-border" (click)="addChild()">

            <i class="bi bi-plus-square me-1"></i>Add Child
          </button>
        </div>
        <div class="card-body">
          <div *ngIf="!parent.children || parent.children.length === 0" class="text-center text-muted">
            <p>No children registered yet.</p>
          </div>

          <!-- If there are multiple children, display only the currently selected child in this column -->
          <ng-container *ngIf="parent.children && parent.children.length > 1; else singleChildren">
            <div class="p-3 pb-0 pt-0 mb-3">
              <div class="card card-detail_pages card-custom-no-hover">
                <div class="card-header">
                  <div class="d-flex align-items-start flex-wrap row-gap-2 row_direction">
                    <div
                      class="d-flex align-items-center justify-content-center avatar avatar-xxl border border-dashed me-2 flex-shrink-0 text-dark frames">
                      <img loading="lazy" [src]="currentChild?.profilePicture || 'assets/child.png'" class="img-fluid"
                        alt="Child Photo">
                      <span class="badge badge-age d-inline-flex align-items-center mb-2">{{ currentChild?.gender }}
                        years old</span>
                    </div>
                    <div class="overflow-hidden">
                      <h5 class="mb-1 text-truncate name-user">{{ currentChild?.firstName }} {{ currentChild?.lastName
                        }}</h5>
                    </div>
                  </div>
                </div>
                <div class="card-body">
                  <h5 class="mb-3 title-body">Basic Information</h5>
                  <dl class="row mb-0 table">
                    <dt class="col-6 title-dt-body-card mb-2">Date of Birth</dt>
                    <dd class="col-6 description-dt-body-card mb-2">{{ formatDate(currentChild?.dateOfBirth) }}</dd>
                    <dt class="col-6 title-dt-body-card mb-2">Gender</dt>
                    <dd class="col-6 description-dt-body-card mb-2">{{ currentChild?.gender }}</dd>
                    <dt class="col-6 title-dt-body-card mb-2">Allergies</dt>
                    <dd class="col-6 description-dt-body-card mb-2">{{ (currentChild?.allergies?.length ?? 0) > 1 ?
                      currentChild?.allergies : 'Nothing' }}</dd>
                    <dt class="col-6 title-dt-body-card mb-2">Medical note</dt>
                    <dd class="col-6 description-dt-body-card mb-2">{{ (currentChild?.medicalNotes?.length ?? 0) > 1 ?
                      currentChild?.medicalNotes : 'Nothing' }}</dd>
                    <dt class="col-6 title-dt-body-card mb-2">emergency Contact</dt>
                    <dd class="col-6 description-dt-body-card mb-2">{{ parent.emergencyContact }}</dd>
                    <dt class="col-6 title-dt-body-card mb-3">Registration Date</dt>
                    <dd class="col-6 description-dt-body-card mb-3">{{ formatDate(parent.createdAt) }}</dd>
                  </dl>
                </div>

              </div>
            </div>
          </ng-container>
          <ng-template #singleChildren>
            <div *ngFor="let child of parent.children" class="p-3 pb-0 pt-0 mb-3">
              <div class="card card-detail_pages card-custom-no-hover ">
                <div class="card-header">
                  <div class="d-flex align-items-start flex-wrap row-gap-2 row_direction">
                    <div
                      class="d-flex align-items-center justify-content-center avatar avatar-xxl border border-dashed me-2 flex-shrink-0 text-dark frames">
                      <img loading="lazy" [src]="child.profilePicture || 'assets/child.png'" class="img-fluid"
                        alt="Child Photo">
                      <span class="badge badge-age d-inline-flex align-items-center mb-2">{{ child.age }} years
                        old</span>
                    </div>
                    <div class="overflow-hidden">
                      <h5 class="mb-1 text-truncate name-user">{{ child.firstName }} {{ child.lastName }}</h5>
                    </div>
                  </div>
                </div>
                <div class="card-body">
                  <h5 class="mb-3 title-body">Basic Information</h5>
                  <dl class="row mb-0 table">
                    <dt class="col-6 title-dt-body-card mb-2">Date of Birth</dt>
                    <dd class="col-6 description-dt-body-card mb-2">{{ formatDate(child.dateOfBirth) }}</dd>
                    <dt class="col-6 title-dt-body-card mb-2">Gender</dt>
                    <dd class="col-6 description-dt-body-card mb-2">{{ child.gender }}</dd>
                    <dt class="col-6 title-dt-body-card mb-2">Allergies</dt>
                    <dd class="col-6 description-dt-body-card mb-2">{{ (child.allergies?.length ?? 0) > 1 ?
                      child.allergies : 'Nothing' }}</dd>
                    <dt class="col-6 title-dt-body-card mb-2">Medical note</dt>
                    <dd class="col-6 description-dt-body-card mb-2">{{ (child.medicalNotes?.length ?? 0) > 1 ?
                      child.medicalNotes : 'Nothing' }}</dd>
                    <dt class="col-6 title-dt-body-card mb-2">emergency Contact</dt>
                    <dd class="col-6 description-dt-body-card mb-2">{{ parent.emergencyContact }}</dd>
                    <dt class="col-6 title-dt-body-card mb-3">Registration Date</dt>
                    <dd class="col-6 description-dt-body-card mb-3">{{ formatDate(parent.createdAt) }}</dd>
                  </dl>
                </div>
                <div class="card-footer">
                  <div class="d-flex col-12 align-items-center justify-content-end action-child">
                    <button class="custom-btn-2 btn-remove-2" (click)="removeChildFromParent(child.id, child.firstName + ' ' + child.lastName)">
                      <i class="bi bi-trash me-2"></i>
                      Remove
                    </button> <button class="custom-btn-2 btn-add-global-2" (click)="addFeeForChild(child.id, child.firstName + ' ' + child.lastName)">
                      <i class="bi bi-plus-circle-dotted me-2"></i>
                      Add Fees
                    </button>
                    <button class="custom-btn-2 btn-view-global-2" (click)="viewChildDetails(child.id)">
                      <i class="bi bi-eye me-2 me-2"></i>
                      View Details
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </ng-template>
        </div>
        <div class="card-footer">
          <div class="d-flex w-100 align-items-center justify-content-between action-child">
            <div class="d-flex align-items-center">
              <ng-container *ngIf="parent.children && parent.children.length > 1">
                <div class="btn-group btn-group-sm me-2" role="group" aria-label="Children navigation">
                  <button class="btn btn-outline-secondary" type="button" (click)="prevChild()" title="Previous child">
                    <i class="bi bi-chevron-left"></i>
                  </button>
                  <button class="btn btn-outline-secondary disabled" type="button">{{ currentChildIndex + 1 }} / {{ parent.children.length }}</button>
                  <button class="btn btn-outline-secondary" type="button" (click)="nextChild()" title="Next child">
                    <i class="bi bi-chevron-right"></i>
                  </button>
                </div>
              </ng-container>
            </div>

            <div class="d-flex align-items-center gap-2">
              <button class="custom-btn-2 btn-remove-2" (click)="removeChildFromParent(currentChild?.id!, (currentChild?.firstName || '') + ' ' + (currentChild?.lastName || ''))">
                <i class="bi bi-trash me-2"></i>
                Remove
              </button>
              <button class="custom-btn-2 btn-add-global-2" (click)="addFeeForChild(currentChild?.id!, (currentChild?.firstName || '') + ' ' + (currentChild?.lastName || ''))">
                <i class="bi bi-plus-circle-dotted me-2"></i>
                Add Fees
              </button>
              <button class="custom-btn-2 btn-view-global-2" (click)="viewChildDetails(currentChild?.id!)">
                <i class="bi bi-eye me-2"></i>
                View Details
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Select Existing Child Modal -->
  <div class="modal fade show d-block" *ngIf="showSelectChildModal" style="background-color: rgba(0,0,0,0.5)"
    (click)="closeSelectChildModal()">
    <div class="modal-dialog modal-lg modal-dialog-centered sweet-center" (click)="$event.stopPropagation()">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Select Existing Child</h5>
          <button type="button" class="btn-close" (click)="closeSelectChildModal()"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <input type="text" class="form-control" placeholder="Search by name..." [(ngModel)]="searchTerm"
              (ngModelChange)="filterChildren()">
          </div>
          <div *ngIf="filteredChildren.length === 0" class="text-center text-muted py-4">
            <p>No available children found</p>
          </div>
          <div class="list-group" style="max-height: 400px; overflow-y: auto;">
            <button *ngFor="let child of filteredChildren" type="button" class="list-group-item list-group-item-action"
              (click)="linkChildToParent(child.id!)" [disabled]="linkingChild">
              <div class="d-flex align-items-center">
                <img loading="lazy"
                  [src]="child.profilePicture || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4NCiAgPGNpcmNsZSBjeD0iMTAwIiBjeT0iMTAwIiByPSI4MCIgZmlsbD0iI0YwRTY4QyIvPg0KICA8Y2lyY2xlIGN4PSIxMDAiIGN5PSI4NSIgcj0iMjUiIGZpbGw9IndoaXRlIiBvcGFjaXR5PSIwLjkiLz4NCiAgPGVsbGlwc2UgY3g9IjEwMCIgY3k9IjEzNSIgcng9IjQ1IiByeT0iMzUiIGZpbGw9IndoaXRlIiBvcGFjaXR5PSIwLjkiLz4NCiAgPGNpcmNsZSBjeD0iODUiIGN5PSI4MCIgcj0iNSIgZmlsbD0iIzMzMyIvPg0KICA8Y2lyY2xlIGN4PSIxMTUiIGN5PSI4MCIgcj0iNSIgZmlsbD0iIzMzMyIvPg0KICA8cGF0aCBkPSJNIDg1IDk1IFEgMTAwIDEwNSAxMTUgOTUiIHN0cm9rZT0iIzMzMyIgc3Ryb2tlLXdpZHRoPSIyIiBmaWxsPSJub25lIi8+DQo8L3N2Zz4='"
                  class="rounded-circle me-3" style="width: 50px; height: 50px;" alt="Child Photo">
                <div class="flex-grow-1">
                  <h6 class="mb-0">{{ child.firstName }} {{ child.lastName }}</h6>
                  <small class="text-muted">DOB: {{ formatDate(child.dateOfBirth) }} | Gender: {{ child.gender
                    }}</small>
                </div>
              </div>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Fee Modal -->
  <div class="modal fade show d-block" *ngIf="showAddFee" style="background-color: rgba(0,0,0,0.5)">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add Fee</h5>
          <button type="button" class="btn-close" (click)="cancelAddFee()"></button>
        </div>
        <div class="modal-body">
          <form (ngSubmit)="saveFee()">
            <div class="mb-3">
              <label class="form-label">Amount *</label>
              <input type="number" class="form-control" [(ngModel)]="newFee.amount" name="amount" required min="0"
                step="0.01">
            </div>
            <div class="mb-3">
              <label class="form-label">Description *</label>
              <input type="text" class="form-control" [(ngModel)]="newFee.description" name="description" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Due Date *</label>
              <input type="date" class="form-control" [(ngModel)]="newFee.dueDate" name="dueDate" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Fee Type</label>
              <select class="form-select" [(ngModel)]="newFee.feeType" name="feeType">
                <option value="monthly">Monthly</option>
                <option value="one-time">One-time</option>
                <option value="late-fee">Late Fee</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Notes</label>
              <textarea class="form-control" [(ngModel)]="newFee.notes" name="notes" rows="3"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="cancelAddFee()"
            [disabled]="savingFee">Cancel</button>
          <button type="button" class="btn btn-primary" (click)="saveFee()" [disabled]="savingFee">
            <span *ngIf="savingFee" class="spinner-border spinner-border-sm me-2"></span>
            {{ savingFee ? 'Adding...' : 'Add Fee' }}
          </button>
        </div>
      </div>
    </div>
  </div>
</div>