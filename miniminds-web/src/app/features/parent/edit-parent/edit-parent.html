<div class="container mt-4">
  <app-title-page 
    title="Edit Parent" 
    subtitle="Update parent information and manage children"
    icon="bi bi-pencil-square"
    [breadcrumbs]="breadcrumbs">
  </app-title-page>

  <div *ngIf="loading" class="text-center">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <div *ngIf="!loading">
    <!-- Parent Information -->
    <div class="card card-general mb-4">
      <div class="card-header">
        <h5>Parent Information</h5>
      </div>
      <div class="card-body">
        <form (ngSubmit)="saveParent()">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">First Name *</label>
              <input type="text" class="form-control" [(ngModel)]="parent.firstName" name="firstName" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Last Name *</label>
              <input type="text" class="form-control" [(ngModel)]="parent.lastName" name="lastName" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Email *</label>
              <input type="email" class="form-control" [(ngModel)]="parent.email" name="email" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Phone Number *</label>
              <input type="tel" class="form-control" [(ngModel)]="parent.phoneNumber" name="phoneNumber" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Emergency Contact</label>
              <input type="tel" class="form-control" [(ngModel)]="parent.emergencyContact" name="emergencyContact">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Gender</label>
              <select class="form-select" [(ngModel)]="parent.gender" name="gender">
                <option value="">Select Gender</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Date of Birth</label>
              <input type="date" class="form-control" [(ngModel)]="parent.dateOfBirth" name="dateOfBirth">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Work</label>
              <input type="text" class="form-control" [(ngModel)]="parent.work" name="work" placeholder="Occupation or workplace">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Zip Code</label>
              <input type="text" class="form-control" [(ngModel)]="parent.zipCode" name="zipCode" placeholder="Postal code">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Parent Type</label>
              <select class="form-select" [(ngModel)]="parent.parentType" name="parentType">
                <option value="">Select Parent Type</option>
                <option value="Father">Father</option>
                <option value="Mother">Mother</option>
                <option value="Grandfather">Grandfather</option>
                <option value="Grandmother">Grandmother</option>
                <option value="Guardian">Guardian</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Profile Picture</label>
              <input type="file" class="form-control" (change)="onParentImageSelect($event)" accept="image/*">
              <img *ngIf="imagePreview || parent.profilePicture" 
                   loading="lazy" [src]="imagePreview || parent.profilePicture" 
                   class="mt-2 rounded" width="100" height="100" alt="Preview">
            </div>
            <div class="col-md-6 mb-3">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" [(ngModel)]="parent.isActive" name="isActive" id="isActiveEdit">
                <label class="form-check-label" for="isActiveEdit">
                  Active Status
                </label>
              </div>
            </div>
            <div class="col-12 mb-3">
              <label class="form-label">Address</label>
              <textarea class="form-control" [(ngModel)]="parent.address" name="address" rows="3" placeholder="Enter full address"></textarea>
            </div>
          </div>
          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-add-global" [disabled]="saving">
              <span *ngIf="saving" class="spinner-border spinner-border-sm me-2"></span>
              {{ saving ? 'Saving...' : 'Update Parent' }}
            </button>
            <button type="button" class="btn btn-cancel-global" (click)="cancel()" [disabled]="saving">Cancel</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Children Section -->
    <div class="card card-general">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5>Children ({{ parent.children?.length || 0 }})</h5>
        <button class="btn btn-primary btn-sm" (click)="toggleAddChild()">
          <i class="bi bi-plus-square"></i> Add Child
        </button>
      </div>
      <div class="card-body">
        <!-- Add Child Form -->
        <div *ngIf="showAddChild" class="border rounded p-3 mb-4 bg-light">
          <h6>Add New Child</h6>
          <form (ngSubmit)="addChild()">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">First Name *</label>
                <input type="text" class="form-control" [(ngModel)]="newChild.firstName" name="childFirstName" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Last Name *</label>
                <input type="text" class="form-control" [(ngModel)]="newChild.lastName" name="childLastName" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Date of Birth *</label>
                <input type="date" class="form-control" [(ngModel)]="newChild.dateOfBirth" name="childDateOfBirth" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Gender *</label>
                <select class="form-select" [(ngModel)]="newChild.gender" name="childGender" required>
                  <option value="">Select Gender</option>
                  <option *ngFor="let gender of genders" [value]="gender.value">
                    {{ gender.label }}
                  </option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Profile Picture</label>
                <input type="file" class="form-control" (change)="onChildImageSelect($event)" accept="image/*">
                <img *ngIf="childImagePreview" loading="lazy" [src]="childImagePreview" class="mt-2 rounded" width="80" height="80" alt="Preview">
              </div>
              <div class="col-12 mb-3">
                <label class="form-label">Allergies</label>
                <textarea class="form-control" [(ngModel)]="newChild.allergies" name="childAllergies" rows="2"></textarea>
              </div>
              <div class="col-12 mb-3">
                <label class="form-label">Medical Notes</label>
                <textarea class="form-control" [(ngModel)]="newChild.medicalNotes" name="childMedicalNotes" rows="2"></textarea>
              </div>
            </div>
            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-success btn-sm" [disabled]="saving">
                <span *ngIf="saving" class="spinner-border spinner-border-sm me-2"></span>
                {{ saving ? 'Adding...' : 'Add Child' }}
              </button>
              <button type="button" class="btn btn-secondary btn-sm" (click)="toggleAddChild()" [disabled]="saving">Cancel</button>
            </div>
          </form>
        </div>

        <!-- Children List -->
        <div *ngIf="!parent.children || parent.children.length === 0" class="text-center text-muted">
          <p>No children registered yet.</p>
        </div>
        
        <div *ngFor="let child of parent.children" class="border rounded p-3 mb-3">
          <div class="d-flex align-items-center">
            <img loading="lazy" [src]="child.profilePicture || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4NCiAgPGNpcmNsZSBjeD0iMTAwIiBjeT0iMTAwIiByPSI4MCIgZmlsbD0iI0YwRTY4QyIvPg0KICA8Y2lyY2xlIGN4PSIxMDAiIGN5PSI4NSIgcj0iMjUiIGZpbGw9IndoaXRlIiBvcGFjaXR5PSIwLjkiLz4NCiAgPGVsbGlwc2UgY3g9IjEwMCIgY3k9IjEzNSIgcng9IjQ1IiByeT0iMzUiIGZpbGw9IndoaXRlIiBvcGFjaXR5PSIwLjkiLz4NCiAgPGNpcmNsZSBjeD0iODUiIGN5PSI4MCIgcj0iNSIgZmlsbD0iIzMzMyIvPg0KICA8Y2lyY2xlIGN4PSIxMTUiIGN5PSI4MCIgcj0iNSIgZmlsbD0iIzMzMyIvPg0KICA8cGF0aCBkPSJNIDg1IDk1IFEgMTAwIDEwNSAxMTUgOTUiIHN0cm9rZT0iIzMzMyIgc3Ryb2tlLXdpZHRoPSIyIiBmaWxsPSJub25lIi8+DQo8L3N2Zz4='"
                 class="rounded-circle me-3" width="60" height="60" alt="Child">
            <div class="flex-grow-1">
              <h6 class="mb-1">{{ child.firstName }} {{ child.lastName }}</h6>
              <p class="mb-0 text-muted">{{ child.gender }} â€¢ {{ child.age }} years old</p>
              <small class="text-muted">Born: {{ child.dateOfBirth | date:'mediumDate' }}</small>
            </div>
            <div class="text-end">
              <button class="btn btn-outline-primary btn-sm me-2" 
                      [routerLink]="['/children/edit', child.id]">
                <i class="bi bi-pencil-square"></i> Edit
              </button>
              <button class="btn btn-outline-info btn-sm" 
                      [routerLink]="['/children/detail', child.id]">
                <i class="bi bi-eye"></i> View
              </button>
            </div>
          </div>
          <div *ngIf="child.allergies || child.medicalNotes" class="mt-2 pt-2 border-top">
            <small class="text-muted d-block" *ngIf="child.allergies">
              <strong>Allergies:</strong> {{ child.allergies }}
            </small>
            <small class="text-muted d-block" *ngIf="child.medicalNotes">
              <strong>Medical Notes:</strong> {{ child.medicalNotes }}
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
