<div class="parent-menu-view font-inter">
  <app-parent-child-header-simple title="Food Menu">
  </app-parent-child-header-simple>

  <div class="container-fluid body">
    <!-- No Children Message -->
    <div *ngIf="!loading && children.length === 0" class="text-center py-5">
      <i class="bi bi-person-x display-4 text-muted"></i>
      <p class="mt-3 text-muted">No children found linked to your account.</p>
      <p class="text-muted small">Please contact the daycare administrator.</p>
    </div>

    <!-- Child Selector -->
    <div class="child-selector mb-4" *ngIf="children.length > 1">
      <label class="form-label">Select Child</label>
      <select class="form-select" [(ngModel)]="selectedChildId" (change)="onChildChange()">
        <option *ngFor="let child of children" [value]="child.id">
          {{ child.firstName }} {{ child.lastName }}
        </option>
      </select>
    </div>

    <!-- Content only shows when children exist -->
    <ng-container *ngIf="children.length > 0">
      <!-- Allergy Notice -->
      <div class="alert alert-warning mb-4" *ngIf="getSelectedChild()?.allergies">
        <i class="bi bi-exclamation-triangle me-2"></i>
        <strong>Allergies:</strong> {{ getSelectedChild().allergies }}
      </div>

      <!-- Week Navigation -->
    <div class="week-navigation mb-4">
      <div class="d-flex align-items-center justify-content-between">
        <button class="btn btn-outline-secondary" (click)="previousWeek()">
          <i class="bi bi-chevron-left"></i>
        </button>
        <h5 class="mb-0">
          {{ getMonday(selectedDate) | date:'MMM d' }} - {{ getWeekDays()[6] | date:'MMM d, yyyy' }}
        </h5>
        <button class="btn btn-outline-secondary" (click)="nextWeek()">
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>
    </div>

    <!-- Week Days Menu Cards -->
    <div class="week-days-scroll mb-4">
      <div class="d-flex gap-2 overflow-auto pb-2">
        <div *ngFor="let day of getWeekDays()"
             class="day-card p-3 text-center"
             [class.cursor-pointer]="getMenuForDay(day)"
             [class.active]="getMenuForDay(day) && isMenuSelected(getMenuForDay(day)!)"
             [class.today]="isToday(day)"
             [class.has-menu]="getMenuForDay(day)"
             [class.disabled]="!getMenuForDay(day)"
             (click)="onDayClick(day)">
          <small class="d-block text-muted">{{ day | date:'EEE' }}</small>
          <strong class="d-block">{{ day | date:'d' }}</strong>
          <small *ngIf="getMenuForDay(day)" class="d-block mt-1 text-success">
            <i class="bi bi-check-circle"></i>
          </small>
          <small *ngIf="!getMenuForDay(day)" class="d-block mt-1 text-muted">
            No menu
          </small>
        </div>
      </div>
    </div>

    <!-- Loading -->
    <div *ngIf="loading" class="text-center py-5">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-2 text-muted">Loading menu...</p>
    </div>

    <!-- No Menu Selected -->
    <div *ngIf="!loading && !selectedMenu" class="text-center py-5">
      <i class="bi bi-calendar-x display-4 text-muted"></i>
      <p class="mt-3 text-muted">No menu available for this week</p>
    </div>

    <!-- Menu Details -->
    <div *ngIf="!loading && selectedMenu" class="menu-details">
      <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div>
            <h5 class="mb-1">{{ selectedMenu.name }}</h5>
            <small class="text-muted">
              <i class="bi bi-calendar3 me-1"></i>
              {{ selectedMenu.menuDate | date:'fullDate' }}
            </small>
          </div>
          <button class="btn btn-primary" (click)="saveSelections()" [disabled]="savingSelections">
            <span *ngIf="savingSelections" class="spinner-border spinner-border-sm me-2"></span>
            {{ savingSelections ? 'Saving...' : 'Save Preferences' }}
          </button>
        </div>

        <div class="card-body">
          <!-- Allergy Warnings -->
          <div class="alert alert-danger mb-4" *ngIf="childMenuView?.allergyWarnings?.length">
            <strong><i class="bi bi-exclamation-triangle me-2"></i>Allergy Warnings:</strong>
            <ul class="mb-0 mt-2">
              <li *ngFor="let warning of childMenuView?.allergyWarnings || []">{{ warning }}</li>
            </ul>
          </div>

          <!-- Menu Description -->
          <p *ngIf="selectedMenu.description" class="text-muted mb-4">
            {{ selectedMenu.description }}
          </p>

          <!-- Meals by Type -->
          <div *ngFor="let mealType of mealTypes" class="meal-section mb-4">
            <h6 class="meal-type-header">
              <i class="bi me-2" [class]="getMealTypeIcon(mealType)"></i>
              {{ mealType }}
            </h6>

            <div class="meal-items">
              <div *ngFor="let item of getItemsForMealType(mealType)"
                   class="meal-item p-3 mb-2 border rounded"
                   [class.selected]="selections[item.id]?.isSelected"
                   [class.warning]="hasAllergyWarning(item)"
                   (click)="toggleSelection(item.id)">
                <div class="d-flex align-items-start">
                  <div class="selection-checkbox me-3">
                    <i class="bi" [class.bi-check-square-fill]="selections[item.id]?.isSelected"
                       [class.bi-square]="!selections[item.id]?.isSelected"
                       [class.text-success]="selections[item.id]?.isSelected"></i>
                  </div>
                  <div class="flex-grow-1">
                    <strong>{{ item.foodItem.name }}</strong>
                    <span *ngIf="item.servingSize" class="text-muted ms-2">({{ item.servingSize }})</span>
                    <p *ngIf="item.foodItem.description" class="text-muted small mb-1">
                      {{ item.foodItem.description }}
                    </p>

                    <!-- Nutritional Info - COMMENTED OUT
                    <div class="d-flex gap-3 small" *ngIf="item.foodItem.calories">
                      <span class="text-info">
                        <i class="bi bi-fire"></i> {{ item.foodItem.calories }} cal
                      </span>
                      <span *ngIf="item.foodItem.protein" class="text-secondary">
                        Protein: {{ item.foodItem.protein }}g
                      </span>
                    </div>
                    -->

                    <!-- Allergens -->
                    <div *ngIf="item.foodItem.allergens" class="mt-1">
                      <span class="badge bg-warning text-dark">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        {{ item.foodItem.allergens }}
                      </span>
                    </div>

                    <!-- Notes Input -->
                    <div class="mt-2" *ngIf="selections[item.id]" (click)="$event.stopPropagation()">
                      <input type="text" class="form-control form-control-sm"
                             placeholder="Add a note (e.g., extra portion, allergies)"
                             [(ngModel)]="selections[item.id].notes">
                    </div>
                  </div>
                </div>
              </div>

              <div *ngIf="getItemsForMealType(mealType).length === 0"
                   class="text-center text-muted py-3">
                <small>No items for {{ mealType }}</small>
              </div>
            </div>
          </div>

          <!-- Nutrition Summary - COMMENTED OUT
          <div class="nutrition-summary p-3 bg-light rounded" *ngIf="selectedMenu.nutritionSummary">
            <h6><i class="bi bi-bar-chart me-2"></i>Daily Nutrition Summary</h6>
            <div class="row text-center mt-3">
              <div class="col">
                <div class="nutrition-value">{{ selectedMenu.nutritionSummary.totalCalories }}</div>
                <small class="text-muted">Calories</small>
              </div>
              <div class="col">
                <div class="nutrition-value">{{ selectedMenu.nutritionSummary.totalProtein }}g</div>
                <small class="text-muted">Protein</small>
              </div>
              <div class="col">
                <div class="nutrition-value">{{ selectedMenu.nutritionSummary.totalCarbohydrates }}g</div>
                <small class="text-muted">Carbs</small>
              </div>
              <div class="col">
                <div class="nutrition-value">{{ selectedMenu.nutritionSummary.totalFat }}g</div>
                <small class="text-muted">Fat</small>
              </div>
            </div>
          </div>
          -->
        </div>
      </div>

      <!-- CACFP Compliance -->
      <div class="card">
        <div class="card-header">
          <h6 class="mb-0"><i class="bi bi-shield-check me-2"></i>CACFP Compliance</h6>
        </div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-3">
              <div class="compliance-badge" [class.met]="selectedMenu.meetsGrainRequirement">
                <i class="bi" [class.bi-check-circle-fill]="selectedMenu.meetsGrainRequirement"
                   [class.bi-x-circle]="!selectedMenu.meetsGrainRequirement"></i>
                <small class="d-block">Grain</small>
              </div>
            </div>
            <div class="col-3">
              <div class="compliance-badge" [class.met]="selectedMenu.meetsProteinRequirement">
                <i class="bi" [class.bi-check-circle-fill]="selectedMenu.meetsProteinRequirement"
                   [class.bi-x-circle]="!selectedMenu.meetsProteinRequirement"></i>
                <small class="d-block">Protein</small>
              </div>
            </div>
            <div class="col-3">
              <div class="compliance-badge" [class.met]="selectedMenu.meetsDairyRequirement">
                <i class="bi" [class.bi-check-circle-fill]="selectedMenu.meetsDairyRequirement"
                   [class.bi-x-circle]="!selectedMenu.meetsDairyRequirement"></i>
                <small class="d-block">Dairy</small>
              </div>
            </div>
            <div class="col-3">
              <div class="compliance-badge" [class.met]="selectedMenu.meetsFruitVegRequirement">
                <i class="bi" [class.bi-check-circle-fill]="selectedMenu.meetsFruitVegRequirement"
                   [class.bi-x-circle]="!selectedMenu.meetsFruitVegRequirement"></i>
                <small class="d-block">Fruit/Veg</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    </ng-container>
  </div>
</div>
